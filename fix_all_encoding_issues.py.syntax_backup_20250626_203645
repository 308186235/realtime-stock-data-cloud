#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä¿®å¤é¡¹ç›®ä¸­æ‰€æœ‰ç¼–ç é—®é¢˜,åŒ…æ‹¬BOMå­—ç¬¦,ç‰¹æ®Šå­—ç¬¦ç­‰
"""

import os
import re
import shutil
from datetime import datetime

def fix_file_encoding_issues(file_path):
    """ä¿®å¤å•ä¸ªæ–‡ä»¶çš„æ‰€æœ‰ç¼–ç é—®é¢˜"""
    try:
        # å°è¯•ä¸åŒçš„ç¼–ç è¯»å–æ–‡ä»¶
        content = None
        encoding_used = None
        
        for encoding in ['utf-8-sig', 'utf-8', 'gbk', 'gb2312', 'latin1']:
            try:
                with open(file_path, 'r', encoding=encoding) as f:
                    content = f.read()
                    encoding_used = encoding
                    break
            except:
                continue
        
        if content is None:
            print(f"âŒ æ— æ³•è¯»å–æ–‡ä»¶: {file_path}")
            return False
        
        original_content = content
        
        # 1. ç§»é™¤BOMå­—ç¬¦
        if content.startswith('\ufeff'):
            content = content[1:]
            print(f"ğŸ”§ ç§»é™¤BOMå­—ç¬¦: {file_path}")
        
        # 2. ç§»é™¤nullå­—èŠ‚
        if '\x00' in content:
            content = content.replace('\x00', '')
            print(f"ğŸ”§ ç§»é™¤nullå­—èŠ‚: {file_path}")
        
        # 3. ä¿®å¤ä¸­æ–‡æ ‡ç‚¹ç¬¦å·
        content = content.replace(',', ',')  # ä¸­æ–‡é€—å· -> è‹±æ–‡é€—å·
        content = content.replace(',', ',')  # ä¸­æ–‡é¡¿å· -> è‹±æ–‡é€—å·
        content = content.replace('"', '"')  # ä¸­æ–‡å·¦åŒå¼•å·
        content = content.replace('"', '"')  # ä¸­æ–‡å³åŒå¼•å·
        content = content.replace(''''''', "'")  # ä¸­æ–‡å³å•å¼•å·
        content = content.replace('(', '(')  # ä¸­æ–‡å·¦æ‹¬å·
        content = content.replace(')', ')')  # ä¸­æ–‡å³æ‹¬å·
        content = content.replace(':', ':')  # ä¸­æ–‡å†’å·
        content = content.replace(';', ';')  # ä¸­æ–‡åˆ†å·
        content = content.replace('?', '?')  # ä¸­æ–‡é—®å·
        content = content.replace('!', '!')  # ä¸­æ–‡æ„Ÿå¹å·
        
        # 4. ç§»é™¤å…¶ä»–ç‰¹æ®ŠUnicodeå­—ç¬¦
        # ç§»é™¤é›¶å®½å­—ç¬¦
        content = re.sub(r'[\u200b-\u200f\u2028-\u202f\u205f-\u206f\ufeff]', '', content)
        
        # ç§»é™¤æ§åˆ¶å­—ç¬¦(ä¿ç•™æ¢è¡Œç¬¦,åˆ¶è¡¨ç¬¦,å›è½¦ç¬¦)
        content = re.sub(r'[\x00-\x08\x0b\x0c\x0e-\x1f\x7f-\x9f]', '', content)
        
        # 5. ä¿®å¤å¸¸è§çš„ç¼–ç é”™è¯¯å­—ç¬¦
        replacements = {
            '\ue511': '',  # ç‰¹æ®Šå­—ç¬¦
            '\ue750': '',
            '\ue5c5': '',
            '\ue752': '',
            '\ufe3f': '',
            '\u2033': '',
            '\ue6ed': '',
            '\uff0c': ',',  # å…¨è§’é€—å·
            '\u3001': ',',  # ä¸­æ–‡é¡¿å·
            '\uff08': '(',  # å…¨è§’å·¦æ‹¬å·
            '\uff09': ')',  # å…¨è§’å³æ‹¬å·
            '\uff1a': ':',  # å…¨è§’å†’å·
            '\uff1b': ';',  # å…¨è§’åˆ†å·
            '\uff1f': '?',  # å…¨è§’é—®å·
            '\uff01': '!',  # å…¨è§’æ„Ÿå¹å·
        }
        
        for wrong, correct in replacements.items():
            content = content.replace(wrong, correct)
        
        # 6. ä¿®å¤ç¼©è¿›é—®é¢˜(ç»Ÿä¸€ä½¿ç”¨4ä¸ªç©ºæ ¼)
        lines = content.split('\n')
        fixed_lines = []
        
        for line in lines:
            # å°†åˆ¶è¡¨ç¬¦è½¬æ¢ä¸º4ä¸ªç©ºæ ¼
            line = line.expandtabs(4)
            fixed_lines.append(line)
        
        content = '\n'.join(fixed_lines)
        
        # 7. ç¡®ä¿æ–‡ä»¶ä»¥æ¢è¡Œç¬¦ç»“å°¾
        if content and not content.endswith('\n'):
            content += '\n'
        
        # å¦‚æœå†…å®¹æœ‰å˜åŒ–,åˆ™ä¿å­˜
        if content != original_content:
            # å¤‡ä»½åŸæ–‡ä»¶
            backup_path = f"{file_path}.backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
            shutil.copy2(file_path, backup_path)
            
            # ä¿å­˜ä¿®å¤åçš„æ–‡ä»¶(ä½¿ç”¨UTF-8ç¼–ç )
            with open(file_path, 'w', encoding='utf-8', newline='') as f:
                f.write(content)
            
            print(f"âœ… ä¿®å¤æ–‡ä»¶: {file_path}")
            return True
        else:
            return False
            
    except Exception as e:
        print(f"âŒ ä¿®å¤å¤±è´¥ {file_path}: {e}")
        return False

def scan_and_fix_all_files():
    """æ‰«æå¹¶ä¿®å¤æ‰€æœ‰æ–‡ä»¶"""
    print("ğŸ” å¼€å§‹æ‰«æå¹¶ä¿®å¤æ‰€æœ‰ç¼–ç é—®é¢˜...")
    
    # éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶æ‰©å±•å
    extensions = ['.py', '.js', '.vue', '.json', '.md', '.txt', '.csv', '.yml', '.yaml']
    
    # éœ€è¦è·³è¿‡çš„ç›®å½•
    skip_dirs = {
        '__pycache__', '.git', 'node_modules', '.vscode', 
        'backup_deleted_20250624_224708', 'logs', 'models', 'venv',
        'unpackage', 'dist'
    }
    
    fixed_files = []
    error_files = []
    
    # éå†é¡¹ç›®ç›®å½•
    for root, dirs, files in os.walk('.'):
        # è·³è¿‡æŒ‡å®šç›®å½•
        dirs[:] = [d for d in dirs if d not in skip_dirs]
        
        for file in files:
            # æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
            if any(file.endswith(ext) for ext in extensions):
                file_path = os.path.join(root, file)
                
                try:
                    if fix_file_encoding_issues(file_path):
                        fixed_files.append(file_path)
                except Exception as e:
                    error_files.append((file_path, str(e)))
    
    # è¾“å‡ºç»“æœ
    print(f"\nğŸ“Š ä¿®å¤ç»“æœ:")
    print(f"âœ… æˆåŠŸä¿®å¤: {len(fixed_files)} ä¸ªæ–‡ä»¶")
    print(f"âŒ ä¿®å¤å¤±è´¥: {len(error_files)} ä¸ªæ–‡ä»¶")
    
    if fixed_files:
        print(f"\nâœ… å·²ä¿®å¤çš„æ–‡ä»¶:")
        for file_path in fixed_files[:20]:  # åªæ˜¾ç¤ºå‰20ä¸ª
            print(f"  - {file_path}")
        if len(fixed_files) > 20:
            print(f"  ... è¿˜æœ‰ {len(fixed_files) - 20} ä¸ªæ–‡ä»¶")
    
    if error_files:
        print(f"\nâŒ ä¿®å¤å¤±è´¥çš„æ–‡ä»¶:")
        for file_path, error in error_files[:10]:  # åªæ˜¾ç¤ºå‰10ä¸ª
            print(f"  - {file_path}: {error}")
        if len(error_files) > 10:
            print(f"  ... è¿˜æœ‰ {len(error_files) - 10} ä¸ªæ–‡ä»¶")

def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("é¡¹ç›®ç¼–ç é—®é¢˜å…¨é¢ä¿®å¤å·¥å…·")
    print("=" * 60)
    
    scan_and_fix_all_files()
    
    print("\nğŸ‰ ç¼–ç ä¿®å¤å®Œæˆ!")
    print("\nğŸ’¡ å»ºè®®:")
    print("1. è¿è¡Œ python check_missing_dependencies.py é‡æ–°æ£€æŸ¥ä¾èµ–")
    print("2. æµ‹è¯•å…³é”®åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ")
    print("3. å¦‚æœ‰é—®é¢˜,å¯ä»¥ä»å¤‡ä»½æ–‡ä»¶æ¢å¤")

if __name__ == "__main__":
    main()

# 交易软件导出系统完整说明

## 系统概述

交易软件具有完整的数据导出和自动清理功能，能够导出持仓、成交、委托三类数据，并自动管理文件生命周期。

## 导出功能

### 支持的数据类型

1. **持仓数据** (W键切换)
   - 文件名格式: `持仓数据_MMDD_HHMMSS.csv`
   - 包含字段: 证券代码、证券名称、股票余额、可用余额、冻结数量、盈亏、市值、成本价、现价

2. **成交数据** (E键切换)
   - 文件名格式: `成交数据_MMDD_HHMMSS.csv`
   - 包含字段: 成交时间、证券代码、证券名称、买卖方向、成交价格、成交数量、成交金额、手续费

3. **委托数据** (R键切换)
   - 文件名格式: `委托数据_MMDD_HHMMSS.csv`
   - 包含字段: 委托时间、证券代码、证券名称、买卖方向、委托价格、委托数量、成交数量、撤单数量、委托状态

### 导出流程

1. **自动切换到交易软件**
   - 查找窗口标题包含"交易"或"股票"的窗口
   - 强制激活并置顶窗口

2. **确保操作环境**
   - 点击中央区域获取焦点
   - 确保Caps Lock开启(W/E/R键需要)
   - 等待状态稳定

3. **页面切换**
   - 发送对应按键(W/E/R)切换到目标页面
   - 等待页面加载完成

4. **执行导出**
   - 点击表格区域
   - 按Ctrl+S打开保存对话框
   - 输入带时间戳的文件名
   - 按回车保存文件
   - 按N关闭确认对话框

### 文件格式

- **编码**: UTF-8-BOM (确保中文正确显示)
- **格式**: CSV (逗号分隔值)
- **扩展名**: .csv

## 自动清理功能

### 清理规则

系统会在每次导出前自动清理过期文件，清理规则如下：

- **当前时间 < 15:00**: 删除昨天15:00之前的文件
- **当前时间 >= 15:00**: 删除今天15:00之前的文件

### 清理范围

清理以下文件模式：
- `持仓数据_*.csv`
- `成交数据_*.csv`
- `委托数据_*.csv`
- `测试过期文件_*.csv`

### 清理逻辑

```python
# 获取当前时间
now = datetime.now()

# 判断过期时间:今天15点
today_3pm = datetime.combine(now.date(), dt_time(15, 0))

# 如果现在还没到15点,则以昨天15点为过期时间
if now < today_3pm:
    cutoff_time = today_3pm - timedelta(days=1)
else:
    cutoff_time = today_3pm

# 删除修改时间早于cutoff_time的文件
```

## 示例数据

### 持仓数据示例
```csv
证券代码,证券名称,股票余额,可用余额,冻结数量,盈亏,市值,成本价,现价
000001,平安银行,1000,1000,0,+150.00,12500.00,12.35,12.50
000002,万科A,500,500,0,-25.00,5475.00,11.00,10.95
600036,招商银行,800,800,0,+320.00,28800.00,35.60,36.00
```

### 成交数据示例
```csv
成交时间,证券代码,证券名称,买卖方向,成交价格,成交数量,成交金额,手续费
09:30:15,000001,平安银行,买入,12.35,1000,12350.00,12.35
10:15:30,000002,万科A,买入,11.00,500,5500.00,5.50
14:30:45,600036,招商银行,买入,35.60,800,28480.00,28.48
```

### 委托数据示例
```csv
委托时间,证券代码,证券名称,买卖方向,委托价格,委托数量,成交数量,撤单数量,委托状态
09:25:00,000001,平安银行,买入,12.35,1000,1000,0,已成交
10:10:00,000002,万科A,买入,11.00,500,500,0,已成交
14:25:00,600036,招商银行,买入,35.60,800,800,0,已成交
14:55:00,000858,五粮液,买入,180.00,100,0,100,已撤单
```

## 核心模块

### trader_export.py
主要导出功能模块，包含：
- `export_holdings()`: 导出持仓数据
- `export_transactions()`: 导出成交数据  
- `export_orders()`: 导出委托数据
- `export_all_data()`: 导出所有数据
- `get_export_files()`: 获取导出文件列表

### trader_core.py
核心功能模块，包含：
- `switch_to_trading_software()`: 切换到交易软件
- `generate_unique_filename()`: 生成唯一文件名
- `cleanup_old_export_files()`: 清理过期文件
- `ensure_caps_lock_on()`: 确保Caps Lock开启

## 使用方法

### 单独导出
```python
from trader_export import export_holdings, export_transactions, export_orders

# 导出持仓数据
result = export_holdings()

# 导出成交数据
result = export_transactions()

# 导出委托数据
result = export_orders()
```

### 批量导出
```python
from trader_export import export_all_data

# 导出所有数据
results = export_all_data()
print(f"成功导出: {sum(results.values())}/3")
```

### 获取导出文件
```python
from trader_export import get_export_files

files = get_export_files()
for file_type, file_list in files.items():
    print(f"{file_type}: {len(file_list)} 个文件")
```

## 优势特点

1. **自动化程度高**: 无需手动操作，一键完成导出
2. **数据完整性**: 支持三种核心交易数据类型
3. **文件管理智能**: 自动清理过期文件，避免磁盘空间浪费
4. **编码兼容性**: 使用UTF-8-BOM编码，确保中文正确显示
5. **时间戳命名**: 文件名包含精确时间戳，便于版本管理
6. **错误处理**: 完善的异常处理机制，提高系统稳定性

## 注意事项

1. **交易软件要求**: 需要交易软件处于运行状态
2. **Caps Lock要求**: W/E/R键导航需要Caps Lock开启
3. **窗口焦点**: 确保交易软件窗口获得焦点
4. **文件权限**: 确保当前目录有写入权限
5. **清理时机**: 文件会在15:00后自动清理，请及时备份重要数据

## 系统集成

该导出系统已完全集成到交易软件中，支持：
- 手动触发导出
- 定时自动导出
- API接口调用
- 批处理脚本执行

通过这套完整的导出和清理系统，用户可以方便地获取和管理交易数据，同时保持系统的整洁和高效运行。

"""
Supabaseé…ç½®å’Œè¿æ¥ç®¡ç†
"""
import os
import logging
from typing import Dict, Any, Optional
from supabase import create_client, Client
import asyncio
import asyncpg

logger = logging.getLogger(__name__)

class SupabaseConfig:
    """Supabaseé…ç½®ç®¡ç†"""
    
    def __init__(self):
        # ä»ç¯å¢ƒå˜é‡æˆ–ç›´æ¥é…ç½®è·å–Supabaseä¿¡æ¯
        self.url = os.getenv('SUPABASE_URL', '')
        self.key = os.getenv('SUPABASE_ANON_KEY', '')
        self.service_key = os.getenv('SUPABASE_SERVICE_KEY', '')
        self.db_url = os.getenv('SUPABASE_DB_URL', '')
        
        # å¦‚æœç¯å¢ƒå˜é‡ä¸ºç©ºï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶
        if not self.url:
            self._load_from_config()
        
        self.client: Optional[Client] = None
        self.db_pool: Optional[asyncpg.Pool] = None
    
    def _load_from_config(self):
        """ä»é…ç½®æ–‡ä»¶åŠ è½½ï¼ˆé¡¹ç›®åˆ›å»ºåå¡«å†™ï¼‰"""
        # å®é™…çš„Supabaseé¡¹ç›®è¿æ¥ä¿¡æ¯
        self.url = os.getenv("SUPABASE_URL")
        self.key = os.getenv("SUPABASE_ANON_KEY")
        self.service_key = ""  # éœ€è¦ä»è®¾ç½®ä¸­è·å–service_role key
        self.db_url = os.getenv("DATABASE_URL")
    
    def get_client(self) -> Client:
        """è·å–Supabaseå®¢æˆ·ç«¯"""
        if not self.client:
            if not self.url or not self.key:
                raise ValueError("Supabase URLå’ŒKeyæœªé…ç½®")
            
            self.client = create_client(self.url, self.key)
            logger.info("Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
        
        return self.client
    
    async def get_db_pool(self) -> asyncpg.Pool:
        """è·å–æ•°æ®åº“è¿æ¥æ± """
        if not self.db_pool:
            if not self.db_url:
                raise ValueError("æ•°æ®åº“URLæœªé…ç½®")
            
            self.db_pool = await asyncpg.create_pool(
                self.db_url,
                min_size=1,
                max_size=10,
                command_timeout=60
            )
            logger.info("æ•°æ®åº“è¿æ¥æ± åˆ›å»ºæˆåŠŸ")
        
        return self.db_pool
    
    async def close_db_pool(self):
        """å…³é—­æ•°æ®åº“è¿æ¥æ± """
        if self.db_pool:
            await self.db_pool.close()
            self.db_pool = None
            logger.info("æ•°æ®åº“è¿æ¥æ± å·²å…³é—­")

# å…¨å±€é…ç½®å®ä¾‹
supabase_config = SupabaseConfig()

class SupabaseService:
    """SupabaseæœåŠ¡å°è£…"""
    
    def __init__(self):
        self.config = supabase_config
    
    async def get_portfolios(self, user_id: str) -> Dict[str, Any]:
        """è·å–ç”¨æˆ·æŠ•èµ„ç»„åˆ"""
        try:
            client = self.config.get_client()
            
            response = client.table('portfolios').select(
                '*, holdings(*, stocks(name))'
            ).eq('user_id', user_id).execute()
            
            return {
                "success": True,
                "data": response.data
            }
        except Exception as e:
            logger.error(f"è·å–æŠ•èµ„ç»„åˆå¤±è´¥: {str(e)}")
            return {
                "success": False,
                "error": str(e)
            }
    
    async def get_stock_prices(self, stock_codes: list) -> Dict[str, Any]:
        """è·å–è‚¡ç¥¨ä»·æ ¼"""
        try:
            client = self.config.get_client()
            
            response = client.table('stock_prices').select(
                '*'
            ).in_('stock_code', stock_codes).order(
                'timestamp', desc=True
            ).limit(len(stock_codes)).execute()
            
            return {
                "success": True,
                "data": response.data
            }
        except Exception as e:
            logger.error(f"è·å–è‚¡ç¥¨ä»·æ ¼å¤±è´¥: {str(e)}")
            return {
                "success": False,
                "error": str(e)
            }
    
    async def create_transaction(self, transaction_data: Dict[str, Any]) -> Dict[str, Any]:
        """åˆ›å»ºäº¤æ˜“è®°å½•"""
        try:
            client = self.config.get_client()
            
            response = client.table('transactions').insert(
                transaction_data
            ).execute()
            
            return {
                "success": True,
                "data": response.data
            }
        except Exception as e:
            logger.error(f"åˆ›å»ºäº¤æ˜“è®°å½•å¤±è´¥: {str(e)}")
            return {
                "success": False,
                "error": str(e)
            }
    
    async def get_ai_analysis(self, stock_code: str = None) -> Dict[str, Any]:
        """è·å–AIåˆ†æç»“æœ"""
        try:
            client = self.config.get_client()
            
            query = client.table('ai_analysis').select('*')
            
            if stock_code:
                query = query.eq('stock_code', stock_code)
            
            response = query.order('created_at', desc=True).limit(10).execute()
            
            return {
                "success": True,
                "data": response.data
            }
        except Exception as e:
            logger.error(f"è·å–AIåˆ†æå¤±è´¥: {str(e)}")
            return {
                "success": False,
                "error": str(e)
            }
    
    async def get_strategies(self, user_id: str) -> Dict[str, Any]:
        """è·å–ç”¨æˆ·ç­–ç•¥"""
        try:
            client = self.config.get_client()
            
            response = client.table('strategies').select(
                '*'
            ).eq('user_id', user_id).execute()
            
            return {
                "success": True,
                "data": response.data
            }
        except Exception as e:
            logger.error(f"è·å–ç­–ç•¥å¤±è´¥: {str(e)}")
            return {
                "success": False,
                "error": str(e)
            }
    
    async def update_stock_price(self, stock_code: str, price_data: Dict[str, Any]) -> bool:
        """æ›´æ–°è‚¡ç¥¨ä»·æ ¼"""
        try:
            client = self.config.get_client()
            
            # æ’å…¥æ–°çš„ä»·æ ¼è®°å½•
            response = client.table('stock_prices').insert({
                'stock_code': stock_code,
                **price_data
            }).execute()
            
            return True
        except Exception as e:
            logger.error(f"æ›´æ–°è‚¡ç¥¨ä»·æ ¼å¤±è´¥: {str(e)}")
            return False
    
    async def batch_update_stock_prices(self, price_data_list: list) -> bool:
        """æ‰¹é‡æ›´æ–°è‚¡ç¥¨ä»·æ ¼"""
        try:
            client = self.config.get_client()
            
            # æ‰¹é‡æ’å…¥ä»·æ ¼è®°å½•
            response = client.table('stock_prices').insert(
                price_data_list
            ).execute()
            
            logger.info(f"æ‰¹é‡æ›´æ–°äº† {len(price_data_list)} æ¡è‚¡ç¥¨ä»·æ ¼")
            return True
        except Exception as e:
            logger.error(f"æ‰¹é‡æ›´æ–°è‚¡ç¥¨ä»·æ ¼å¤±è´¥: {str(e)}")
            return False

# å…¨å±€æœåŠ¡å®ä¾‹
supabase_service = SupabaseService()

async def test_connection():
    """æµ‹è¯•Supabaseè¿æ¥"""
    try:
        client = supabase_config.get_client()
        
        # æµ‹è¯•æŸ¥è¯¢ç³»ç»Ÿé…ç½®è¡¨
        response = client.table('system_config').select('*').limit(1).execute()
        
        print("âœ… Supabaseè¿æ¥æµ‹è¯•æˆåŠŸ!")
        print(f"ğŸ“Š æŸ¥è¯¢ç»“æœ: {response.data}")
        return True
    except Exception as e:
        print(f"âŒ Supabaseè¿æ¥æµ‹è¯•å¤±è´¥: {str(e)}")
        return False

if __name__ == "__main__":
    # æµ‹è¯•è¿æ¥
    asyncio.run(test_connection())

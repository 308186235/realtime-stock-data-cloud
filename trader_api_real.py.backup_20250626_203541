"""
äº¤æ˜“API - çœŸæ­£çš„åŸç‰ˆæ¨¡å—åŒ–
Agentè°ƒç”¨æ¥å£ï¼ŒåŸºäºå®Œå…¨åŸç‰ˆé€»è¾‘
"""

from trader_buy_sell import buy_stock, sell_stock
from trader_export_real import export_holdings, export_transactions, export_orders
from trader_core_original import cleanup_old_export_files
import win32gui
import glob

class TradingAPI:
    """äº¤æ˜“APIç±» - çœŸæ­£çš„åŸç‰ˆæ¨¡å—åŒ–"""
    
    def buy(self, code, quantity, price="å¸‚ä»·"):
        """ä¹°å…¥è‚¡ç¥¨"""
        return buy_stock(code, quantity, price)
    
    def sell(self, code, quantity, price="å¸‚ä»·"):
        """å–å‡ºè‚¡ç¥¨"""
        return sell_stock(code, quantity, price)
    
    def export_positions(self):
        """å¯¼å‡ºæŒä»“æ•°æ®"""
        return export_holdings()
    
    def export_trades(self):
        """å¯¼å‡ºæˆäº¤æ•°æ®"""
        return export_transactions()
    
    def export_orders(self):
        """å¯¼å‡ºå§”æ‰˜æ•°æ®"""
        return export_orders()
    
    def export_all(self):
        """å¯¼å‡ºæ‰€æœ‰æ•°æ®"""
        results = {}
        results['holdings'] = self.export_positions()
        results['transactions'] = self.export_trades()
        results['orders'] = self.export_orders()
        return results
    
    def batch_trade(self, trades):
        """æ‰¹é‡äº¤æ˜“"""
        results = []
        for trade in trades:
            if trade['action'] == 'buy':
                success = self.buy(trade['code'], trade['quantity'], trade.get('price', 'å¸‚ä»·'))
            elif trade['action'] == 'sell':
                success = self.sell(trade['code'], trade['quantity'], trade.get('price', 'å¸‚ä»·'))
            else:
                success = False
            
            results.append({
                'trade': trade,
                'success': success
            })
        
        return results
    
    def get_files(self):
        """è·å–å¯¼å‡ºæ–‡ä»¶åˆ—è¡¨"""
        files = {
            'holdings': glob.glob("æŒä»“æ•°æ®_*.csv"),
            'transactions': glob.glob("æˆäº¤æ•°æ®_*.csv"),
            'orders': glob.glob("å§”æ‰˜æ•°æ®_*.csv")
        }
        return files
    
    def cleanup_files(self):
        """æ¸…ç†è¿‡æœŸæ–‡ä»¶"""
        cleanup_old_export_files()
    
    def get_status(self):
        """è·å–ç³»ç»ŸçŠ¶æ€"""
        try:
            current_hwnd = win32gui.GetForegroundWindow()
            current_title = win32gui.GetWindowText(current_hwnd)
            
            # æ£€æŸ¥äº¤æ˜“è½¯ä»¶æ˜¯å¦æ¿€æ´»
            trading_active = "äº¤æ˜“" in current_title or "è‚¡ç¥¨" in current_title
            
            # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
            files = self.get_files()
            file_counts = {
                'holdings_count': len(files['holdings']),
                'transactions_count': len(files['transactions']),
                'orders_count': len(files['orders'])
            }
            
            return {
                'current_window': current_title,
                'trading_software_active': trading_active,
                'export_files': file_counts
            }
        except:
            return {
                'current_window': 'æœªçŸ¥',
                'trading_software_active': False,
                'export_files': {'holdings_count': 0, 'transactions_count': 0, 'orders_count': 0}
            }

# åˆ›å»ºå…¨å±€APIå®ä¾‹
api = TradingAPI()

# æµ‹è¯•å‡½æ•°
def test_api():
    """æµ‹è¯•APIåŠŸèƒ½"""
    print("ğŸ§ª æµ‹è¯•çœŸæ­£çš„åŸç‰ˆAPI")
    print("=" * 40)
    
    # æµ‹è¯•çŠ¶æ€æŸ¥è¯¢
    print("\nğŸ“Š ç³»ç»ŸçŠ¶æ€:")
    status = api.get_status()
    print(f"å½“å‰çª—å£: {status['current_window']}")
    print(f"äº¤æ˜“è½¯ä»¶æ¿€æ´»: {status['trading_software_active']}")
    
    files = status['export_files']
    print(f"å¯¼å‡ºæ–‡ä»¶: æŒä»“{files['holdings_count']} æˆäº¤{files['transactions_count']} å§”æ‰˜{files['orders_count']}")
    
    print("\nâœ… APIæµ‹è¯•å®Œæˆ")

if __name__ == "__main__":
    test_api()

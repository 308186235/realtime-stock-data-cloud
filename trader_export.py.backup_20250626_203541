"""
äº¤æ˜“ç¨‹åºå¯¼å‡ºæ¨¡å—
æä¾›æŒä»“ã€æˆäº¤ã€å§”æ‰˜æ•°æ®å¯¼å‡ºåŠŸèƒ½
"""

import win32api
import win32con
import win32gui
import time
from trader_core import (
    switch_to_trading_software,
    clear_and_type,
    send_key_fast,
    generate_unique_filename,
    cleanup_old_export_files,
    get_current_focus,
    click_center_area,
    click_table_area,
    ensure_caps_lock_on
)

def export_data_generic(page_key, page_name, file_prefix):
    """
    é€šç”¨å¯¼å‡ºæ•°æ®å‡½æ•°
    
    Args:
        page_key (int): é¡µé¢åˆ‡æ¢æŒ‰é”®ç  (W=0x57, E=0x45, R=0x52)
        page_name (str): é¡µé¢åç§°
        file_prefix (str): æ–‡ä»¶åå‰ç¼€
    
    Returns:
        bool: æ“ä½œæ˜¯å¦æˆåŠŸ
    """
    print(f"\nğŸ“Š å¯¼å‡º{page_name}")
    print("-" * 40)

    # æ¸…ç†è¿‡æœŸæ–‡ä»¶
    cleanup_old_export_files()

    # è‡ªåŠ¨åˆ‡æ¢åˆ°äº¤æ˜“è½¯ä»¶
    if not switch_to_trading_software():
        print("âŒ æ— æ³•åˆ‡æ¢åˆ°äº¤æ˜“è½¯ä»¶ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»äº¤æ˜“è½¯ä»¶çª—å£åé‡è¯•")
        return False

    try:
        # 1. å¼ºåˆ¶ç¡®ä¿ç„¦ç‚¹åœ¨äº¤æ˜“è½¯ä»¶
        print("1. å¼ºåˆ¶ç¡®ä¿ç„¦ç‚¹åœ¨äº¤æ˜“è½¯ä»¶...")
        for i in range(3):  # å°è¯•3æ¬¡
            current_hwnd = win32gui.GetForegroundWindow()
            current_title = win32gui.GetWindowText(current_hwnd)
            print(f"   ç¬¬{i+1}æ¬¡æ£€æŸ¥ï¼Œå½“å‰çª—å£: {current_title}")

            if "äº¤æ˜“" in current_title or "è‚¡ç¥¨" in current_title:
                print("   âœ… ç„¦ç‚¹åœ¨äº¤æ˜“è½¯ä»¶")
                break
            else:
                print("   âŒ ç„¦ç‚¹ä¸åœ¨äº¤æ˜“è½¯ä»¶ï¼Œé‡æ–°åˆ‡æ¢...")
                if not switch_to_trading_software():
                    print("   åˆ‡æ¢å¤±è´¥ï¼Œç»§ç»­å°è¯•...")
                time.sleep(0.5)

        # 2. ç‚¹å‡»ä¸­å¤®åŒºåŸŸè·å–ç„¦ç‚¹
        print("2. ç‚¹å‡»ä¸­å¤®åŒºåŸŸè·å–ç„¦ç‚¹...")
        click_center_area()

        # 3. ç¡®ä¿Caps Lockå¼€å¯
        print("3. ç¡®ä¿Caps Lockå¼€å¯...")
        ensure_caps_lock_on()

        # 4. ç­‰å¾…çŠ¶æ€ç¨³å®š
        time.sleep(0.5)

        # 5. å‘é€é¡µé¢åˆ‡æ¢é”®
        print(f"5. å‘é€{chr(page_key)}é”®åˆ‡æ¢åˆ°{page_name}...")
        win32api.keybd_event(page_key, 0, 0, 0)
        win32api.keybd_event(page_key, 0, win32con.KEYEVENTF_KEYUP, 0)
        time.sleep(0.1)  # ç­‰å¾…0.1ç§’åå¼€å§‹å¯¼å‡º
        print(f"   {chr(page_key)}é”®å‘é€å®Œæˆ")

        print(f"   ç­‰å¾…{page_name}é¡µé¢åŠ è½½å®Œæˆ...")

        # 6. ç”Ÿæˆæ–‡ä»¶å
        filename = generate_unique_filename(file_prefix)
        print(f"æ–‡ä»¶å: {filename}")

        # 7. ç‚¹å‡»è¡¨æ ¼åŒºåŸŸ
        print("7. ç‚¹å‡»è¡¨æ ¼åŒºåŸŸ...")
        click_table_area()
        time.sleep(0.1)

        # 8. æŒ‰Ctrl+Så¯¼å‡º
        print("8. æŒ‰Ctrl+Så¯¼å‡º...")
        win32api.keybd_event(win32con.VK_CONTROL, 0, 0, 0)  # CtrlæŒ‰ä¸‹
        time.sleep(0.01)
        win32api.keybd_event(ord('S'), 0, 0, 0)  # Sé”®æŒ‰ä¸‹
        time.sleep(0.01)
        win32api.keybd_event(ord('S'), 0, win32con.KEYEVENTF_KEYUP, 0)  # Sé”®é‡Šæ”¾
        time.sleep(0.01)
        win32api.keybd_event(win32con.VK_CONTROL, 0, win32con.KEYEVENTF_KEYUP, 0)  # Ctrlé‡Šæ”¾
        time.sleep(0.5)  # ç­‰å¾…å¯¼å‡ºå¯¹è¯æ¡†

        # 9. è¾“å…¥æ–‡ä»¶å
        print("9. è¾“å…¥æ–‡ä»¶å...")
        clear_and_type(filename)
        time.sleep(0.5)

        # 10. æŒ‰å›è½¦ä¿å­˜
        print("10. æŒ‰å›è½¦ä¿å­˜...")
        send_key_fast(win32con.VK_RETURN)
        time.sleep(2.0)  # ç­‰å¾…æ–‡ä»¶ä¿å­˜

        # 11. æŒ‰Nå…³é—­ç¡®è®¤å¯¹è¯æ¡†
        print("11. æŒ‰Nå…³é—­ç¡®è®¤å¯¹è¯æ¡†...")
        win32api.keybd_event(0x4E, 0, 0, 0)  # Né”®æŒ‰ä¸‹
        win32api.keybd_event(0x4E, 0, win32con.KEYEVENTF_KEYUP, 0)  # Né”®é‡Šæ”¾
        time.sleep(0.3)

        print(f"âœ… {page_name}å¯¼å‡ºå®Œæˆ!")
        return True

    except Exception as e:
        print(f"âŒ {page_name}å¯¼å‡ºå¤±è´¥: {e}")
        return False

def export_holdings():
    """
    å¯¼å‡ºæŒä»“æ•°æ®
    
    Returns:
        bool: æ“ä½œæ˜¯å¦æˆåŠŸ
    """
    return export_data_generic(0x57, "æŒä»“æ•°æ®", "æŒä»“æ•°æ®")  # Wé”®

def export_transactions():
    """
    å¯¼å‡ºæˆäº¤æ•°æ®
    
    Returns:
        bool: æ“ä½œæ˜¯å¦æˆåŠŸ
    """
    return export_data_generic(0x45, "æˆäº¤æ•°æ®", "æˆäº¤æ•°æ®")  # Eé”®

def export_orders():
    """
    å¯¼å‡ºå§”æ‰˜æ•°æ®
    
    Returns:
        bool: æ“ä½œæ˜¯å¦æˆåŠŸ
    """
    return export_data_generic(0x52, "å§”æ‰˜æ•°æ®", "å§”æ‰˜æ•°æ®")  # Ré”®

def export_all_data():
    """
    å¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼ˆæŒä»“ã€æˆäº¤ã€å§”æ‰˜ï¼‰
    
    Returns:
        dict: å„é¡¹å¯¼å‡ºç»“æœ
    """
    print("\nğŸ¯ å¯¼å‡ºæ‰€æœ‰æ•°æ®")
    print("=" * 50)
    
    results = {
        "holdings": False,
        "transactions": False,
        "orders": False
    }
    
    # å¯¼å‡ºæŒä»“æ•°æ®
    print("\nğŸ“Š 1/3 å¯¼å‡ºæŒä»“æ•°æ®...")
    results["holdings"] = export_holdings()
    time.sleep(1.0)
    
    # å¯¼å‡ºæˆäº¤æ•°æ®
    print("\nğŸ“Š 2/3 å¯¼å‡ºæˆäº¤æ•°æ®...")
    results["transactions"] = export_transactions()
    time.sleep(1.0)
    
    # å¯¼å‡ºå§”æ‰˜æ•°æ®
    print("\nğŸ“Š 3/3 å¯¼å‡ºå§”æ‰˜æ•°æ®...")
    results["orders"] = export_orders()
    
    # æ€»ç»“
    success_count = sum(results.values())
    print(f"\nâœ… å¯¼å‡ºå®Œæˆ! æˆåŠŸ: {success_count}/3")
    
    for data_type, success in results.items():
        status = "âœ…" if success else "âŒ"
        print(f"   {status} {data_type}")
    
    return results

def get_export_files():
    """
    è·å–å½“å‰ç›®å½•ä¸‹çš„å¯¼å‡ºæ–‡ä»¶åˆ—è¡¨
    
    Returns:
        dict: æŒ‰ç±»å‹åˆ†ç»„çš„æ–‡ä»¶åˆ—è¡¨
    """
    import glob
    
    files = {
        "holdings": glob.glob("æŒä»“æ•°æ®_*.csv"),
        "transactions": glob.glob("æˆäº¤æ•°æ®_*.csv"),
        "orders": glob.glob("å§”æ‰˜æ•°æ®_*.csv")
    }
    
    return files

# æµ‹è¯•å‡½æ•°
if __name__ == "__main__":
    print("ğŸ§ª æµ‹è¯•å¯¼å‡ºæ¨¡å—")
    
    # æµ‹è¯•å•ä¸ªå¯¼å‡º
    print("\n=== æµ‹è¯•æŒä»“å¯¼å‡º ===")
    result = export_holdings()
    print(f"æŒä»“å¯¼å‡ºç»“æœ: {result}")
    
    # æµ‹è¯•è·å–æ–‡ä»¶åˆ—è¡¨
    print("\n=== è·å–å¯¼å‡ºæ–‡ä»¶ ===")
    files = get_export_files()
    for file_type, file_list in files.items():
        print(f"{file_type}: {len(file_list)} ä¸ªæ–‡ä»¶")
        for file in file_list[:3]:  # åªæ˜¾ç¤ºå‰3ä¸ª
            print(f"  - {file}")

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ngrokå†…ç½‘ç©¿é€è®¾ç½®è„šæœ¬
ç”¨äºå°†æœ¬åœ°æœåŠ¡æš´éœ²åˆ°å…¬ç½‘
"""

import subprocess
import time
import requests
import json
import os

def check_ngrok_installed():
    """æ£€æŸ¥ngrokæ˜¯å¦å·²å®‰è£…"""
    try:
        result = subprocess.run(['ngrok', 'version'], capture_output=True, text=True)
        if result.returncode == 0:
            print("âœ… ngrokå·²å®‰è£…")
            print(f"ç‰ˆæœ¬: {result.stdout.strip()}")
            return True
        else:
            print("âŒ ngrokæœªå®‰è£…")
            return False
    except FileNotFoundError:
        print("âŒ ngrokæœªå®‰è£…")
        return False

def download_ngrok():
    """ä¸‹è½½å¹¶å®‰è£…ngrok"""
    print("ğŸ“¥ æ­£åœ¨ä¸‹è½½ngrok...")
    print("è¯·è®¿é—®: https://ngrok.com/download")
    print("1. ä¸‹è½½Windowsç‰ˆæœ¬çš„ngrok")
    print("2. è§£å‹åˆ°å½“å‰ç›®å½•æˆ–æ·»åŠ åˆ°PATH")
    print("3. æ³¨å†Œngrokè´¦å·è·å–authtoken")
    print("4. è¿è¡Œ: ngrok authtoken <your-token>")
    
def start_ngrok_tunnel():
    """å¯åŠ¨ngrokéš§é“"""
    print("ğŸš€ å¯åŠ¨ngrokéš§é“...")
    
    try:
        # å¯åŠ¨ngrokéš§é“
        process = subprocess.Popen(
            ['ngrok', 'http', '8000'],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        
        print("â³ ç­‰å¾…ngrokå¯åŠ¨...")
        time.sleep(3)
        
        # è·å–ngrokçŠ¶æ€
        try:
            response = requests.get('http://localhost:4040/api/tunnels')
            if response.status_code == 200:
                tunnels = response.json()['tunnels']
                if tunnels:
                    public_url = tunnels[0]['public_url']
                    print(f"âœ… ngrokéš§é“å·²å¯åŠ¨!")
                    print(f"ğŸŒ å…¬ç½‘åœ°å€: {public_url}")
                    print(f"ğŸ”— æœ¬åœ°åœ°å€: http://localhost:8000")
                    
                    # æµ‹è¯•è¿æ¥
                    test_url = f"{public_url}/api/health"
                    try:
                        test_response = requests.get(test_url, timeout=10)
                        if test_response.status_code == 200:
                            print(f"âœ… å…¬ç½‘è®¿é—®æµ‹è¯•æˆåŠŸ!")
                            print(f"ğŸ“Š å¥åº·æ£€æŸ¥: {test_response.json()}")
                        else:
                            print(f"âš ï¸ å…¬ç½‘è®¿é—®æµ‹è¯•å¤±è´¥: {test_response.status_code}")
                    except Exception as e:
                        print(f"âš ï¸ å…¬ç½‘è®¿é—®æµ‹è¯•å¤±è´¥: {e}")
                    
                    return public_url
                else:
                    print("âŒ æœªæ‰¾åˆ°æ´»åŠ¨çš„éš§é“")
            else:
                print("âŒ æ— æ³•è·å–ngrokçŠ¶æ€")
        except Exception as e:
            print(f"âŒ è·å–ngrokçŠ¶æ€å¤±è´¥: {e}")
            
    except FileNotFoundError:
        print("âŒ ngrokå‘½ä»¤æœªæ‰¾åˆ°ï¼Œè¯·å…ˆå®‰è£…ngrok")
        return None
    except Exception as e:
        print(f"âŒ å¯åŠ¨ngrokå¤±è´¥: {e}")
        return None

def update_cloudflare_dns(public_url):
    """æ›´æ–°Cloudflare DNSè®°å½•çš„è¯´æ˜"""
    if not public_url:
        return
        
    # æå–åŸŸåéƒ¨åˆ†
    domain = public_url.replace('https://', '').replace('http://', '')
    
    print("\n" + "="*60)
    print("ğŸ“‹ Cloudflare DNSé…ç½®è¯´æ˜")
    print("="*60)
    print(f"1. ç™»å½•Cloudflareæ§åˆ¶å°: https://dash.cloudflare.com")
    print(f"2. é€‰æ‹©åŸŸå: aigupiao.me")
    print(f"3. è¿›å…¥DNSè®¾ç½®")
    print(f"4. æ·»åŠ CNAMEè®°å½•:")
    print(f"   ç±»å‹: CNAME")
    print(f"   åç§°: @")
    print(f"   å†…å®¹: {domain}")
    print(f"   ä»£ç†çŠ¶æ€: å·²ä»£ç† (æ©™è‰²äº‘æœµ)")
    print(f"5. æˆ–è€…æ·»åŠ Aè®°å½•æŒ‡å‘ngrokçš„IP")
    print("="*60)

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸŒ ngrokå†…ç½‘ç©¿é€è®¾ç½®")
    print("="*50)
    
    # æ£€æŸ¥ngrokæ˜¯å¦å®‰è£…
    if not check_ngrok_installed():
        download_ngrok()
        return
    
    # å¯åŠ¨ngrokéš§é“
    public_url = start_ngrok_tunnel()
    
    if public_url:
        # æä¾›DNSé…ç½®è¯´æ˜
        update_cloudflare_dns(public_url)
        
        print(f"\nğŸ‰ è®¾ç½®å®Œæˆ!")
        print(f"ğŸ“± æ‚¨ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®æœåŠ¡:")
        print(f"   æœ¬åœ°: http://localhost:8000")
        print(f"   å…¬ç½‘: {public_url}")
        print(f"\nâš ï¸ æ³¨æ„: ngrokå…è´¹ç‰ˆæœ‰è¿æ¥æ•°é™åˆ¶")
        print(f"ğŸ’¡ å»ºè®®: è€ƒè™‘å‡çº§åˆ°ä»˜è´¹ç‰ˆæˆ–ä½¿ç”¨å…¶ä»–å†…ç½‘ç©¿é€æœåŠ¡")
        
        # ä¿æŒè¿è¡Œ
        print(f"\næŒ‰Ctrl+Cåœæ­¢ngrokéš§é“...")
        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            print(f"\nğŸ‘‹ ngrokéš§é“å·²åœæ­¢")
    else:
        print(f"\nâŒ ngrokè®¾ç½®å¤±è´¥")
        print(f"ğŸ’¡ è¯·æ£€æŸ¥:")
        print(f"   1. ngrokæ˜¯å¦æ­£ç¡®å®‰è£…")
        print(f"   2. æ˜¯å¦å·²è®¾ç½®authtoken")
        print(f"   3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")

if __name__ == "__main__":
    main()

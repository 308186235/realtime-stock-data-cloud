<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabaseå‰ç«¯æœåŠ¡æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-section h3 {
            color: #34495e;
            margin-top: 0;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            background-color: #ecf0f1;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        .status.disconnected {
            background-color: #fadbd8;
            color: #e74c3c;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .input-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Supabaseå‰ç«¯æœåŠ¡æµ‹è¯•</h1>
        
        <div id="connectionStatus" class="status disconnected">
            ğŸ”´ æœªè¿æ¥åˆ°åç«¯æœåŠ¡
        </div>

        <!-- ç”¨æˆ·ç®¡ç†æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ‘¤ ç”¨æˆ·ç®¡ç†æµ‹è¯•</h3>
            <div class="input-group">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="username" value="frontend_test_user" />
            </div>
            <div class="input-group">
                <label>æ˜¾ç¤ºåç§°:</label>
                <input type="text" id="displayName" value="å‰ç«¯æµ‹è¯•ç”¨æˆ·" />
            </div>
            <button onclick="testCreateUser()">åˆ›å»ºç”¨æˆ·</button>
            <button onclick="testGetUser()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
            <button onclick="testGetUsers()">è·å–ç”¨æˆ·åˆ—è¡¨</button>
            <div id="userResult" class="result"></div>
        </div>

        <!-- è‚¡ç¥¨ç®¡ç†æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“ˆ è‚¡ç¥¨ç®¡ç†æµ‹è¯•</h3>
            <button onclick="testCreateStocks()">åˆ›å»ºè‚¡ç¥¨æ± </button>
            <button onclick="testGetStocks()">è·å–è‚¡ç¥¨åˆ—è¡¨</button>
            <button onclick="testGetStock()">è·å–å•åªè‚¡ç¥¨</button>
            <div id="stockResult" class="result"></div>
        </div>

        <!-- æŠ•èµ„ç»„åˆæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ’¼ æŠ•èµ„ç»„åˆæµ‹è¯•</h3>
            <div class="input-group">
                <label>ç»„åˆåç§°:</label>
                <input type="text" id="portfolioName" value="å‰ç«¯æµ‹è¯•ç»„åˆ" />
            </div>
            <div class="input-group">
                <label>åˆå§‹èµ„é‡‘:</label>
                <input type="number" id="initialCash" value="1000000" />
            </div>
            <button onclick="testCreatePortfolio()">åˆ›å»ºæŠ•èµ„ç»„åˆ</button>
            <button onclick="testGetPortfolios()">è·å–æŠ•èµ„ç»„åˆåˆ—è¡¨</button>
            <button onclick="testGetPortfolioDetail()">è·å–ç»„åˆè¯¦æƒ…</button>
            <div id="portfolioResult" class="result"></div>
        </div>

        <!-- äº¤æ˜“æ“ä½œæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ›’ äº¤æ˜“æ“ä½œæµ‹è¯•</h3>
            <div class="input-group">
                <label>è‚¡ç¥¨ä»£ç :</label>
                <input type="text" id="stockCode" value="000001" />
            </div>
            <div class="input-group">
                <label>ä¹°å…¥æ•°é‡:</label>
                <input type="number" id="shares" value="1000" />
            </div>
            <div class="input-group">
                <label>ä¹°å…¥ä»·æ ¼:</label>
                <input type="number" id="price" value="12.50" step="0.01" />
            </div>
            <button onclick="testExecuteBuy()">æ‰§è¡Œä¹°å…¥</button>
            <button onclick="testGetHoldings()">è·å–æŒä»“</button>
            <button onclick="testGetTransactions()">è·å–äº¤æ˜“è®°å½•</button>
            <div id="tradingResult" class="result"></div>
        </div>

        <!-- ç»¼åˆæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ¯ ç»¼åˆåŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testCompleteWorkflow()">å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•</button>
            <button onclick="testPortfolioPerformance()">æŠ•èµ„ç»„åˆè¡¨ç°è®¡ç®—</button>
            <button onclick="testCleanupData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
            <div id="comprehensiveResult" class="result"></div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥SupabaseæœåŠ¡
        import { SupabasePortfolioService } from './services/supabasePortfolioService.js';
        
        // åˆ›å»ºæœåŠ¡å®ä¾‹
        const portfolioService = new SupabasePortfolioService();
        
        // å…¨å±€å˜é‡
        let currentUserId = null;
        let currentPortfolioId = null;
        
        // æ£€æŸ¥åç«¯è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                const response = await fetch('http://localhost:8000/api/supabase/config');
                if (response.ok) {
                    document.getElementById('connectionStatus').className = 'status connected';
                    document.getElementById('connectionStatus').innerHTML = 'ğŸŸ¢ å·²è¿æ¥åˆ°åç«¯æœåŠ¡';
                    return true;
                }
            } catch (error) {
                console.error('è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
            }
            
            document.getElementById('connectionStatus').className = 'status disconnected';
            document.getElementById('connectionStatus').innerHTML = 'ğŸ”´ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡';
            return false;
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, result, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = JSON.stringify(result, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        // ç”¨æˆ·ç®¡ç†æµ‹è¯•
        window.testCreateUser = async function() {
            try {
                const username = document.getElementById('username').value;
                const displayName = document.getElementById('displayName').value;
                
                const userData = {
                    id: crypto.randomUUID(),
                    username: username,
                    email: `${username}@example.com`,
                    display_name: displayName,
                    is_active: true
                };
                
                const result = await portfolioService.createUser(userData);
                currentUserId = result.data.id;
                showResult('userResult', result);
            } catch (error) {
                showResult('userResult', { error: error.message }, true);
            }
        };
        
        window.testGetUser = async function() {
            try {
                if (!currentUserId) {
                    throw new Error('è¯·å…ˆåˆ›å»ºç”¨æˆ·');
                }
                
                const result = await portfolioService.getUser(currentUserId);
                showResult('userResult', result);
            } catch (error) {
                showResult('userResult', { error: error.message }, true);
            }
        };
        
        window.testGetUsers = async function() {
            try {
                const result = await portfolioService.getUsers();
                showResult('userResult', result);
            } catch (error) {
                showResult('userResult', { error: error.message }, true);
            }
        };
        
        // è‚¡ç¥¨ç®¡ç†æµ‹è¯•
        window.testCreateStocks = async function() {
            try {
                const stocks = [
                    { code: '000001', name: 'å¹³å®‰é“¶è¡Œ', market: 'SZ', sector: 'é‡‘è' },
                    { code: '600519', name: 'è´µå·èŒ…å°', market: 'SH', sector: 'æ¶ˆè´¹' },
                    { code: '000858', name: 'äº”ç²®æ¶²', market: 'SZ', sector: 'æ¶ˆè´¹' }
                ];
                
                const results = [];
                for (const stock of stocks) {
                    const result = await portfolioService.createStock(stock);
                    results.push(result);
                }
                
                showResult('stockResult', { message: 'è‚¡ç¥¨æ± åˆ›å»ºå®Œæˆ', results });
            } catch (error) {
                showResult('stockResult', { error: error.message }, true);
            }
        };
        
        window.testGetStocks = async function() {
            try {
                const result = await portfolioService.getStocks();
                showResult('stockResult', result);
            } catch (error) {
                showResult('stockResult', { error: error.message }, true);
            }
        };
        
        window.testGetStock = async function() {
            try {
                const result = await portfolioService.getStock('000001');
                showResult('stockResult', result);
            } catch (error) {
                showResult('stockResult', { error: error.message }, true);
            }
        };
        
        // æŠ•èµ„ç»„åˆæµ‹è¯•
        window.testCreatePortfolio = async function() {
            try {
                if (!currentUserId) {
                    throw new Error('è¯·å…ˆåˆ›å»ºç”¨æˆ·');
                }
                
                const portfolioName = document.getElementById('portfolioName').value;
                const initialCash = parseFloat(document.getElementById('initialCash').value);
                
                const portfolioData = {
                    user_id: currentUserId,
                    name: portfolioName,
                    cash: initialCash,
                    total_value: initialCash,
                    stock_value: 0,
                    is_default: true
                };
                
                const result = await portfolioService.createPortfolio(portfolioData);
                currentPortfolioId = result.data.id;
                showResult('portfolioResult', result);
            } catch (error) {
                showResult('portfolioResult', { error: error.message }, true);
            }
        };
        
        window.testGetPortfolios = async function() {
            try {
                const result = await portfolioService.getPortfolios(currentUserId);
                showResult('portfolioResult', result);
            } catch (error) {
                showResult('portfolioResult', { error: error.message }, true);
            }
        };
        
        window.testGetPortfolioDetail = async function() {
            try {
                if (!currentPortfolioId) {
                    throw new Error('è¯·å…ˆåˆ›å»ºæŠ•èµ„ç»„åˆ');
                }
                
                const result = await portfolioService.getPortfolio(currentPortfolioId);
                showResult('portfolioResult', result);
            } catch (error) {
                showResult('portfolioResult', { error: error.message }, true);
            }
        };
        
        // äº¤æ˜“æ“ä½œæµ‹è¯•
        window.testExecuteBuy = async function() {
            try {
                if (!currentPortfolioId) {
                    throw new Error('è¯·å…ˆåˆ›å»ºæŠ•èµ„ç»„åˆ');
                }
                
                const stockCode = document.getElementById('stockCode').value;
                const shares = parseInt(document.getElementById('shares').value);
                const price = parseFloat(document.getElementById('price').value);
                
                const tradeData = {
                    portfolioId: currentPortfolioId,
                    stockCode: stockCode,
                    shares: shares,
                    price: price,
                    notes: `å‰ç«¯æµ‹è¯•ä¹°å…¥${stockCode}`
                };
                
                const result = await portfolioService.executeBuyOrder(tradeData);
                showResult('tradingResult', result);
            } catch (error) {
                showResult('tradingResult', { error: error.message }, true);
            }
        };
        
        window.testGetHoldings = async function() {
            try {
                const result = await portfolioService.getHoldings(currentPortfolioId);
                showResult('tradingResult', result);
            } catch (error) {
                showResult('tradingResult', { error: error.message }, true);
            }
        };
        
        window.testGetTransactions = async function() {
            try {
                const result = await portfolioService.getTransactions({ portfolio_id: currentPortfolioId });
                showResult('tradingResult', result);
            } catch (error) {
                showResult('tradingResult', { error: error.message }, true);
            }
        };
        
        // ç»¼åˆæµ‹è¯•
        window.testCompleteWorkflow = async function() {
            try {
                showResult('comprehensiveResult', { message: 'å¼€å§‹å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•...' });
                
                // 1. åˆ›å»ºç”¨æˆ·
                const userData = {
                    id: crypto.randomUUID(),
                    username: 'workflow_test_user',
                    email: 'workflow@example.com',
                    display_name: 'å·¥ä½œæµç¨‹æµ‹è¯•ç”¨æˆ·',
                    is_active: true
                };
                
                const userResult = await portfolioService.createUser(userData);
                const userId = userResult.data.id;
                
                // 2. åˆ›å»ºæŠ•èµ„ç»„åˆ
                const portfolioData = {
                    user_id: userId,
                    name: 'å·¥ä½œæµç¨‹æµ‹è¯•ç»„åˆ',
                    cash: 500000,
                    total_value: 500000,
                    stock_value: 0,
                    is_default: true
                };
                
                const portfolioResult = await portfolioService.createPortfolio(portfolioData);
                const portfolioId = portfolioResult.data.id;
                
                // 3. æ‰§è¡Œä¹°å…¥æ“ä½œ
                const buyResult = await portfolioService.executeBuyOrder({
                    portfolioId: portfolioId,
                    stockCode: '000001',
                    shares: 2000,
                    price: 12.50,
                    notes: 'å·¥ä½œæµç¨‹æµ‹è¯•ä¹°å…¥'
                });
                
                // 4. è·å–å®Œæ•´æŠ•èµ„ç»„åˆä¿¡æ¯
                const completeResult = await portfolioService.getUserCompletePortfolios(userId);
                
                showResult('comprehensiveResult', {
                    message: 'å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•æˆåŠŸ',
                    user: userResult.data,
                    portfolio: portfolioResult.data,
                    trade: buyResult.data,
                    complete_portfolios: completeResult.data
                });
                
            } catch (error) {
                showResult('comprehensiveResult', { error: error.message }, true);
            }
        };
        
        window.testPortfolioPerformance = async function() {
            try {
                if (!currentPortfolioId) {
                    throw new Error('è¯·å…ˆåˆ›å»ºæŠ•èµ„ç»„åˆå¹¶æ·»åŠ æŒä»“');
                }
                
                const portfolioResult = await portfolioService.getPortfolio(currentPortfolioId);
                const portfolio = portfolioResult.data;
                
                const performance = portfolioService.calculatePortfolioPerformance(portfolio);
                
                showResult('comprehensiveResult', {
                    portfolio: portfolio,
                    performance: performance
                });
            } catch (error) {
                showResult('comprehensiveResult', { error: error.message }, true);
            }
        };
        
        window.testCleanupData = async function() {
            try {
                const result = await portfolioService.cleanupTestData();
                showResult('comprehensiveResult', result);
                
                // é‡ç½®å…¨å±€å˜é‡
                currentUserId = null;
                currentPortfolioId = null;
            } catch (error) {
                showResult('comprehensiveResult', { error: error.message }, true);
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥
        checkConnection();
        
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è¿æ¥çŠ¶æ€
        setInterval(checkConnection, 30000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .control-group input, .control-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .results {
            margin-top: 20px;
        }
        .indicator-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        .indicator-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .indicator-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .value-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        .value-label {
            font-weight: bold;
            color: #666;
        }
        .value-number {
            color: #007bff;
            font-family: monospace;
        }
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 4px;
            color: #666;
            font-size: 16px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .data-table tr:nth-child(even) {
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æµ‹è¯•</h1>
            <p>æµ‹è¯•MAã€MACDã€RSIã€å¸ƒæ—å¸¦ã€KDJç­‰æŠ€æœ¯æŒ‡æ ‡è®¡ç®—åŠŸèƒ½</p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="control-group">
                <label for="stockCode">è‚¡ç¥¨ä»£ç </label>
                <select id="stockCode">
                    <option value="000001">000001 - å¹³å®‰é“¶è¡Œ</option>
                    <option value="600000">600000 - æµ¦å‘é“¶è¡Œ</option>
                    <option value="600519">600519 - è´µå·èŒ…å°</option>
                    <option value="000858">000858 - äº”ç²®æ¶²</option>
                    <option value="002415">002415 - æµ·åº·å¨è§†</option>
                </select>
            </div>
            <div class="control-group">
                <label for="period">æ•°æ®å‘¨æœŸï¼ˆå¤©ï¼‰</label>
                <input type="number" id="period" value="60" min="20" max="250">
            </div>
            <div class="control-group">
                <label for="indicatorType">æŒ‡æ ‡ç±»å‹</label>
                <select id="indicatorType">
                    <option value="all">æ‰€æœ‰æŒ‡æ ‡</option>
                    <option value="ma">ç§»åŠ¨å¹³å‡çº¿</option>
                    <option value="macd">MACD</option>
                    <option value="rsi">RSI</option>
                    <option value="bollinger">å¸ƒæ—å¸¦</option>
                    <option value="kdj">KDJ</option>
                </select>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="calculateIndicators()">è®¡ç®—æŒ‡æ ‡</button>
            <button class="btn btn-success" onclick="getLatestValues()">è·å–æœ€æ–°å€¼</button>
            <button class="btn btn-warning" onclick="testAllStocks()">æµ‹è¯•æ‰€æœ‰è‚¡ç¥¨</button>
            <button class="btn btn-info" onclick="testAPI()">æµ‹è¯•API</button>
        </div>

        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="results" class="results"></div>

        <!-- å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="chart-container">
            <h3>ğŸ“ˆ æŒ‡æ ‡å›¾è¡¨</h3>
            <div class="chart-placeholder">
                ç‚¹å‡»"è®¡ç®—æŒ‡æ ‡"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨æ•°æ®
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(message = 'æ­£åœ¨è®¡ç®—...') {
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    <div>â³ ${message}</div>
                </div>
            `;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            document.getElementById('results').innerHTML = `
                <div class="error">
                    âŒ é”™è¯¯: ${message}
                </div>
            `;
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="success">
                    âœ… ${message}
                </div>
            ` + resultsDiv.innerHTML;
        }

        // è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
        async function calculateIndicators() {
            const stockCode = document.getElementById('stockCode').value;
            const period = document.getElementById('period').value;
            const indicatorType = document.getElementById('indicatorType').value;

            showLoading('æ­£åœ¨è®¡ç®—æŠ€æœ¯æŒ‡æ ‡...');

            try {
                let url = `${API_BASE}/api/technical/indicators/${stockCode}?period=${period}`;
                
                if (indicatorType !== 'all') {
                    // æ ¹æ®é€‰æ‹©çš„æŒ‡æ ‡ç±»å‹æ„å»ºå‚æ•°
                    const indicatorMap = {
                        'ma': 'ma5,ma10,ma20,ma60',
                        'macd': 'macd,signal,histogram',
                        'rsi': 'rsi',
                        'bollinger': 'boll_upper,boll_middle,boll_lower',
                        'kdj': 'k,d,j'
                    };
                    url += `&indicators=${indicatorMap[indicatorType]}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    displayIndicators(result);
                } else {
                    showError('è®¡ç®—å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showError('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæŒ‡æ ‡ç»“æœ
        function displayIndicators(result) {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="indicator-card">
                    <div class="indicator-header">ğŸ“Š ${result.stock_code} - æŠ€æœ¯æŒ‡æ ‡è®¡ç®—ç»“æœ</div>
                    <div class="indicator-values">
                        <div class="value-item">
                            <span class="value-label">æ•°æ®ç‚¹æ•°:</span>
                            <span class="value-number">${result.data_points}</span>
                        </div>
                        <div class="value-item">
                            <span class="value-label">è®¡ç®—å‘¨æœŸ:</span>
                            <span class="value-number">${result.period}å¤©</span>
                        </div>
                        <div class="value-item">
                            <span class="value-label">æŒ‡æ ‡æ•°é‡:</span>
                            <span class="value-number">${Object.keys(result.indicators).length}</span>
                        </div>
                    </div>
                </div>
            `;

            // æ˜¾ç¤ºæœ€æ–°æŒ‡æ ‡å€¼
            if (result.latest_values) {
                html += `
                    <div class="indicator-card">
                        <div class="indicator-header">ğŸ“ˆ æœ€æ–°æŒ‡æ ‡å€¼</div>
                        <div class="indicator-values">
                `;
                
                for (const [key, value] of Object.entries(result.latest_values)) {
                    if (value !== null) {
                        html += `
                            <div class="value-item">
                                <span class="value-label">${key.toUpperCase()}:</span>
                                <span class="value-number">${value}</span>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                    </div>
                `;
            }

            // æ˜¾ç¤ºè¯¦ç»†æ•°æ®è¡¨æ ¼
            html += createDataTable(result.indicators);

            resultsDiv.innerHTML = html;
        }

        // åˆ›å»ºæ•°æ®è¡¨æ ¼
        function createDataTable(indicators) {
            if (!indicators || Object.keys(indicators).length === 0) {
                return '<div class="error">æ²¡æœ‰æŒ‡æ ‡æ•°æ®</div>';
            }

            const indicatorNames = Object.keys(indicators);
            const dataLength = indicators[indicatorNames[0]].length;
            
            let html = `
                <div class="indicator-card">
                    <div class="indicator-header">ğŸ“‹ è¯¦ç»†æ•°æ® (æœ€å10ä¸ªæ•°æ®ç‚¹)</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>åºå·</th>
            `;
            
            // è¡¨å¤´
            indicatorNames.forEach(name => {
                html += `<th>${name.toUpperCase()}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // æ•°æ®è¡Œï¼ˆåªæ˜¾ç¤ºæœ€å10è¡Œï¼‰
            const startIndex = Math.max(0, dataLength - 10);
            for (let i = startIndex; i < dataLength; i++) {
                html += `<tr><td>${i + 1}</td>`;
                indicatorNames.forEach(name => {
                    const value = indicators[name][i];
                    const displayValue = isNaN(value) ? '-' : Number(value).toFixed(4);
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            return html;
        }

        // è·å–æœ€æ–°æŒ‡æ ‡å€¼
        async function getLatestValues() {
            const stockCode = document.getElementById('stockCode').value;
            showLoading('æ­£åœ¨è·å–æœ€æ–°æŒ‡æ ‡å€¼...');

            try {
                const response = await fetch(`${API_BASE}/api/technical/indicators/${stockCode}/latest`);
                const result = await response.json();

                if (result.success) {
                    displayLatestValues(result);
                } else {
                    showError('è·å–å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showError('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæœ€æ–°æŒ‡æ ‡å€¼
        function displayLatestValues(result) {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="indicator-card">
                    <div class="indicator-header">ğŸ¯ ${result.stock_code} - æœ€æ–°æŒ‡æ ‡å€¼</div>
                    <div class="indicator-values">
            `;
            
            for (const [key, value] of Object.entries(result.latest_indicators)) {
                if (value !== null) {
                    html += `
                        <div class="value-item">
                            <span class="value-label">${key.toUpperCase()}:</span>
                            <span class="value-number">${value}</span>
                        </div>
                    `;
                }
            }
            
            html += `
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        // æµ‹è¯•æ‰€æœ‰è‚¡ç¥¨
        async function testAllStocks() {
            const stocks = ['000001', '600000', '600519', '000858', '002415'];
            showLoading('æ­£åœ¨æµ‹è¯•æ‰€æœ‰è‚¡ç¥¨...');

            let results = [];
            
            for (const stock of stocks) {
                try {
                    const response = await fetch(`${API_BASE}/api/technical/indicators/${stock}/latest`);
                    const result = await response.json();
                    results.push({
                        stock: stock,
                        success: result.success,
                        indicators: result.latest_indicators || {}
                    });
                } catch (error) {
                    results.push({
                        stock: stock,
                        success: false,
                        error: error.message
                    });
                }
            }

            displayAllStocksResults(results);
        }

        // æ˜¾ç¤ºæ‰€æœ‰è‚¡ç¥¨æµ‹è¯•ç»“æœ
        function displayAllStocksResults(results) {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="indicator-card">
                    <div class="indicator-header">ğŸ” æ‰€æœ‰è‚¡ç¥¨æµ‹è¯•ç»“æœ</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨ä»£ç </th>
                                <th>çŠ¶æ€</th>
                                <th>MA5</th>
                                <th>MA20</th>
                                <th>RSI</th>
                                <th>MACD</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            results.forEach(result => {
                const status = result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                const ma5 = result.indicators?.ma5 || '-';
                const ma20 = result.indicators?.ma20 || '-';
                const rsi = result.indicators?.rsi || '-';
                const macd = result.indicators?.macd || '-';
                
                html += `
                    <tr>
                        <td>${result.stock}</td>
                        <td>${status}</td>
                        <td>${ma5}</td>
                        <td>${ma20}</td>
                        <td>${rsi}</td>
                        <td>${macd}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            resultsDiv.innerHTML = html;
        }

        // æµ‹è¯•API
        async function testAPI() {
            showLoading('æ­£åœ¨æµ‹è¯•API...');

            try {
                const response = await fetch(`${API_BASE}/api/technical/test`);
                const result = await response.json();

                if (result.success) {
                    showSuccess('APIæµ‹è¯•æˆåŠŸ');
                    displayIndicators(result);
                } else {
                    showError('APIæµ‹è¯•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showError('APIæµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            console.log('æŠ€æœ¯æŒ‡æ ‡æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        };
    </script>
</body>
</html>

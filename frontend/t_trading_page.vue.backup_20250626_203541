<template>
  <view class="container">
    <view class="header">
      <text class="title">Täº¤æ˜“ç­–ç•¥</text>
      <view class="subtitle">
        <text>åˆ©ç”¨T+1åˆ¶åº¦ï¼Œé€šè¿‡æ—¥å†…äº¤æ˜“é™ä½æŒä»“æˆæœ¬</text>
      </view>
    </view>

    <!-- åŸºæœ¬ä¿¡æ¯å’Œæ§åˆ¶åŒº -->
    <view class="control-panel">
      <view class="panel">
        <view class="panel-title">
          <text>äº¤æ˜“æ—¥æ§åˆ¶</text>
        </view>
        <view class="panel-body">
          <view class="field">
            <text class="field-label">å½“å‰æ—¥æœŸ</text>
            <text class="field-value">{{ currentDate }}</text>
          </view>
          <view class="action-buttons">
            <button class="btn" :disabled="isTrading" @click="startTradingDay">å¼€å§‹äº¤æ˜“</button>
            <button class="btn btn-warning" :disabled="!isTrading" @click="endTradingDay">ç»“æŸäº¤æ˜“</button>
          </view>
        </view>
      </view>

      <view class="panel">
        <view class="panel-title">
          <text>å½“æ—¥ç»Ÿè®¡</text>
        </view>
        <view class="panel-body">
          <view class="field">
            <text class="field-label">äº¤æ˜“æ¬¡æ•°</text>
            <text class="field-value">{{ dailyStats.trades || 0 }}</text>
          </view>
          <view class="field">
            <text class="field-label">æˆåŠŸæ¬¡æ•°</text>
            <text class="field-value">{{ dailyStats.successful || 0 }}</text>
          </view>
          <view class="field">
            <text class="field-label">ç›ˆåˆ©é‡‘é¢</text>
            <text class="field-value" :class="{'profit': dailyStats.profit > 0, 'loss': dailyStats.profit < 0}">
              {{ formatMoney(dailyStats.profit || 0) }}
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- è‚¡ç¥¨é€‰æ‹© -->
    <view class="panel stock-selector">
      <view class="panel-title">
        <text>é€‰æ‹©è‚¡ç¥¨</text>
      </view>
      <view class="panel-body">
        <view class="field-row">
          <text class="field-label">è‚¡ç¥¨ä»£ç </text>
          <input type="text" v-model="selectedStock.code" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç " @blur="fetchStockData"/>
        </view>
        <view class="field-row">
          <text class="field-label">è‚¡ç¥¨åç§°</text>
          <input type="text" v-model="selectedStock.name" placeholder="è‚¡ç¥¨åç§°" disabled/>
        </view>
        <view class="field-row">
          <text class="field-label">æŒä»“æ•°é‡</text>
          <input type="number" v-model="selectedStock.basePosition" placeholder="è¾“å…¥åº•ä»“æ•°é‡"/>
        </view>
        <view class="field-row">
          <text class="field-label">æŒä»“æˆæœ¬</text>
          <input type="number" v-model="selectedStock.baseCost" placeholder="è¾“å…¥æŒä»“æˆæœ¬"/>
        </view>
      </view>
    </view>

    <!-- å¸‚åœºè¡Œæƒ… -->
    <view class="panel" v-if="stockInfo.code">
      <view class="panel-title">
        <text>{{ stockInfo.code }} {{ stockInfo.name }} è¡Œæƒ…</text>
        <text class="refresh-btn" @click="fetchStockData">åˆ·æ–°</text>
      </view>
      <view class="panel-body">
        <view class="price-box">
          <text class="current-price" :class="{'price-up': stockInfo.priceChange > 0, 'price-down': stockInfo.priceChange < 0}">
            {{ stockInfo.currentPrice }}
          </text>
          <view class="price-change">
            <text :class="{'price-up': stockInfo.priceChange > 0, 'price-down': stockInfo.priceChange < 0}">
              {{ stockInfo.priceChange > 0 ? '+' : '' }}{{ stockInfo.priceChange }}
              ({{ stockInfo.priceChangePercent }}%)
            </text>
          </view>
        </view>
        
        <view class="market-info">
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">å¼€ç›˜</text>
              <text class="info-value">{{ stockInfo.open }}</text>
            </view>
            <view class="info-item">
              <text class="info-label">æœ€é«˜</text>
              <text class="info-value">{{ stockInfo.high }}</text>
            </view>
            <view class="info-item">
              <text class="info-label">æœ€ä½</text>
              <text class="info-value">{{ stockInfo.low }}</text>
            </view>
          </view>
          <view class="info-row">
            <view class="info-item">
              <text class="info-label">æˆäº¤é‡</text>
              <text class="info-value">{{ formatVolume(stockInfo.volume) }}</text>
            </view>
            <view class="info-item">
              <text class="info-label">æŒ¯å¹…</text>
              <text class="info-value">{{ stockInfo.amplitude }}%</text>
            </view>
            <view class="info-item">
              <text class="info-label">æ¢æ‰‹ç‡</text>
              <text class="info-value">{{ stockInfo.turnoverRate }}%</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æœºä¼šè¯„ä¼°åŒºåŸŸ -->
    <view class="panel" v-if="stockInfo.code">
      <view class="panel-title">
        <text>äº¤æ˜“æœºä¼šè¯„ä¼°</text>
        <view class="ai-badge" v-if="opportunity && opportunity.evaluation_method === 'ai'">
          <view class="ai-icon">AI</view>
          <view class="confidence-meter">
            <view 
              class="confidence-bar" 
              :style="{width: `${(opportunity.ai_confidence || 0) * 100}%`}"
              :class="{
                'high': opportunity.ai_confidence > 0.75,
                'medium': opportunity.ai_confidence <= 0.75 && opportunity.ai_confidence >= 0.6,
                'low': opportunity.ai_confidence < 0.6
              }"
            ></view>
          </view>
        </view>
      </view>
      <view class="panel-body">
        <view class="buttons">
          <button @click="evaluateOpportunity" :disabled="loading">
            <text class="icon">ğŸ”</text>
            <text>{{ loading ? 'åˆ†æä¸­...' : 'è¯„ä¼°æœºä¼š' }}</text>
          </button>
        </view>
        
        <view class="result" v-if="opportunity">
          <view class="result-box" :class="{ 'has-opportunity': opportunity.has_opportunity }">
            <view class="result-header">
              <text class="result-title">AIåˆ†æç»“æœ</text>
              <text class="result-time">{{ lastUpdated || 'ç°åœ¨' }}</text>
            </view>
            
            <view class="result-message">{{ opportunity.message }}</view>
            
            <view class="result-details" v-if="opportunity.has_opportunity">
              <view class="detail-item">
                <text class="detail-label">æ¨èæ“ä½œ</text>
                <text class="detail-value">{{ opportunity.mode === 'positive' ? 'æ­£T (å…ˆä¹°åå–)' : 'åT (å…ˆå–åä¹°)' }}</text>
              </view>
              
              <view class="detail-item">
                <text class="detail-label">å»ºè®®æ•°é‡</text>
                <text class="detail-value">{{ opportunity.suggested_quantity }}è‚¡</text>
              </view>
              
              <view class="detail-item" v-if="opportunity.evaluation_method === 'ai'">
                <text class="detail-label">ç½®ä¿¡åº¦</text>
                <text class="detail-value confidence" :class="getConfidenceClass(opportunity.ai_confidence)">
                  {{ (opportunity.ai_confidence * 100).toFixed(0) }}%
                </text>
              </view>
              
              <view class="detail-item" v-if="opportunity.volatility">
                <text class="detail-label">æ³¢åŠ¨ç‡</text>
                <text class="detail-value">{{ (opportunity.volatility * 100).toFixed(2) }}%</text>
              </view>
              
              <view class="ai-decision-panel" v-if="opportunity.evaluation_method === 'ai' && opportunity.has_opportunity">
                <view class="ai-decision-header">
                  <view class="ai-decision-icon">ğŸ¤–</view>
                  <text class="ai-decision-title">Agentäº¤æ˜“å†³ç­–</text>
                </view>
                
                <view class="ai-decision-body">
                  <text class="ai-decision-message">
                    AIå»ºè®®{{ opportunity.mode === 'positive' ? 'ä¹°å…¥' : 'å–å‡º' }} {{ opportunity.suggested_quantity }}è‚¡ {{ stockInfo.name }}
                    {{ opportunity.mode === 'positive' ? 'ï¼Œå¾…åç»­ä¸Šæ¶¨å–å‡º' : 'ï¼Œå¾…åç»­ä¸‹è·Œä¹°å›' }}
                  </text>
                  
                  <view class="expected-impact" v-if="opportunity.expected_cost_impact">
                    <text class="impact-title">é¢„æœŸæˆæœ¬é™ä½ {{ opportunity.expected_cost_impact.reduction_percentage.toFixed(2) }}%</text>
                    <text class="impact-detail">
                      {{ opportunity.expected_cost_impact.original_cost.toFixed(2) }} â†’ {{ opportunity.expected_cost_impact.new_cost.toFixed(2) }}
                    </text>
                  </view>
                </view>
                
                <view class="ai-decision-actions">
                  <button 
                    class="action-button primary"
                    @click="executeAIDecision(opportunity.mode === 'positive' ? 'buy' : 'sell')"
                  >
                    æ‰§è¡ŒAIå†³ç­–
                  </button>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <view class="trade-form" v-if="opportunity && opportunity.has_opportunity">
          <view class="field-row">
            <text class="field-label">äº¤æ˜“ç±»å‹</text>
            <view class="radio-group">
              <label class="radio-label">
                <input type="radio" value="buy" v-model="tradeInfo.type" :disabled="opportunity.mode === 'negative'"/>
                <text>ä¹°å…¥</text>
              </label>
              <label class="radio-label">
                <input type="radio" value="sell" v-model="tradeInfo.type" :disabled="opportunity.mode === 'positive'"/>
                <text>å–å‡º</text>
              </label>
            </view>
          </view>
          <view class="field-row">
            <text class="field-label">äº¤æ˜“ä»·æ ¼</text>
            <input type="number" v-model="tradeInfo.price" placeholder="è¾“å…¥äº¤æ˜“ä»·æ ¼" />
          </view>
          <view class="field-row">
            <text class="field-label">äº¤æ˜“æ•°é‡</text>
            <input type="number" v-model="tradeInfo.quantity" placeholder="è¾“å…¥äº¤æ˜“æ•°é‡" :max="selectedStock.basePosition" />
          </view>
          <view class="field-row actions">
            <button class="btn btn-primary" @click="submitTrade">æ‰§è¡Œäº¤æ˜“</button>
          </view>
        </view>
      </view>
    </view>

    <!-- Agentäº¤æ˜“åŠ©æ‰‹ -->
    <t-trading-ai-panel
      v-if="stockInfo.code"
      :stockInfo="stockInfo"
      @execute-trade="executeTrade"
    />

    <!-- å†å²Täº¤æ˜“è®°å½• -->
    <view class="panel" v-if="tradingHistory.length > 0">
      <view class="panel-title">
        <text>äº¤æ˜“å†å²</text>
      </view>
      <view class="panel-body">
        <view class="table-container">
          <table class="history-table">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>è‚¡ç¥¨</th>
                <th>ç±»å‹</th>
                <th>ä¹°å…¥ä»·</th>
                <th>å–å‡ºä»·</th>
                <th>æ•°é‡</th>
                <th>åˆ©æ¶¦</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(trade, index) in tradingHistory" :key="index">
                <td>{{ formatDate(trade.date) }}</td>
                <td>{{ trade.stock_code }}</td>
                <td>{{ getTradeModeText(trade) }}</td>
                <td>{{ trade.buy_price || '-' }}</td>
                <td>{{ trade.sell_price || '-' }}</td>
                <td>{{ trade.quantity }}</td>
                <td :class="{'profit': trade.profit > 0, 'loss': trade.profit < 0}">
                  {{ trade.profit ? formatMoney(trade.profit) : '-' }}
                </td>
                <td :class="{'success': trade.status === 'success', 'failure': trade.status === 'failure', 'pending': trade.status === 'pending'}">
                  {{ getTradeStatusText(trade.status) }}
                </td>
              </tr>
            </tbody>
          </table>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import TTradingAIPanel from '@/components/t_trading_ai_panel.vue'

export default {
  components: {
    TTradingAIPanel
  },
  data() {
    return {
      isTrading: false,
      currentDate: this.formatDateString(new Date()),
      selectedStock: {
        code: '',
        name: '',
        basePosition: 100,
        baseCost: 0
      },
      stockInfo: {
        code: '',
        name: '',
        currentPrice: 0,
        open: 0,
        high: 0,
        low: 0,
        priceChange: 0,
        priceChangePercent: 0,
        volume: 0,
        amplitude: 0,
        turnoverRate: 0
      },
      opportunity: null,
      tradeInfo: {
        type: 'buy',
        price: 0,
        quantity: 0
      },
      tradingHistory: [],
      dailyStats: {
        trades: 0,
        successful: 0,
        profit: 0
      },
      loading: false,
      lastUpdated: null
    }
  },
  created() {
    // åˆå§‹åŒ–å½“å‰æ—¥æœŸ
    this.currentDate = this.formatDateString(new Date())
    
    // åŠ è½½äº¤æ˜“å†å²æ•°æ®
    this.loadTradingHistory()
  },
  methods: {
    formatDateString(date) {
      const year = date.getFullYear()
      const month = String(date.getMonth() + 1).padStart(2, '0')
      const day = String(date.getDate()).padStart(2, '0')
      return `${year}-${month}-${day}`
    },
    
    formatDate(dateStr) {
      if (!dateStr) return '-'
      return dateStr.slice(5) // åªæ˜¾ç¤ºæœˆ-æ—¥éƒ¨åˆ†
    },
    
    formatMoney(value) {
      return 'Â¥' + parseFloat(value).toFixed(2)
    },
    
    formatVolume(volume) {
      if (volume >= 100000000) {
        return (volume / 100000000).toFixed(2) + 'äº¿'
      } else if (volume >= 10000) {
        return (volume / 10000).toFixed(2) + 'ä¸‡'
      } else {
        return volume.toString()
      }
    },
    
    // å¼€å§‹äº¤æ˜“æ—¥
    async startTradingDay() {
      try {
        const response = await this.$http.post('/api/t-trading/start-trading-day')
        if (response.data && response.data.status === 'success') {
          this.isTrading = true
          this.currentDate = response.data.date
          this.$toast.success('å·²å¼€å§‹å½“æ—¥Täº¤æ˜“')
        }
      } catch (error) {
        console.error('å¼€å§‹äº¤æ˜“æ—¥å¤±è´¥', error)
        this.$toast.error('å¼€å§‹äº¤æ˜“æ—¥å¤±è´¥: ' + (error.response?.data?.detail || error.message))
      }
    },
    
    // ç»“æŸäº¤æ˜“æ—¥
    async endTradingDay() {
      try {
        const response = await this.$http.post('/api/t-trading/end-trading-day')
        if (response.data && response.data.status === 'success') {
          this.isTrading = false
          this.dailyStats.trades = response.data.trades_count
          this.dailyStats.profit = response.data.daily_profit
          this.$toast.success(`å·²ç»“æŸå½“æ—¥Täº¤æ˜“ï¼Œæ€»åˆ©æ¶¦: ${this.formatMoney(response.data.daily_profit)}`)
          
          // é‡æ–°åŠ è½½äº¤æ˜“å†å²
          this.loadTradingHistory()
        }
      } catch (error) {
        console.error('ç»“æŸäº¤æ˜“æ—¥å¤±è´¥', error)
        this.$toast.error('ç»“æŸäº¤æ˜“æ—¥å¤±è´¥: ' + (error.response?.data?.detail || error.message))
      }
    },
    
    // è·å–è‚¡ç¥¨æ•°æ®
    async fetchStockData() {
      if (!this.selectedStock.code) return
      
      try {
        this.$toast.info('è·å–è‚¡ç¥¨æ•°æ®ä¸­...')
        
        // å®é™…é¡¹ç›®ä¸­åº”å½“ä»APIè·å–æ•°æ®
        const response = await this.$http.get(`/api/stock/quote/${this.selectedStock.code}`)
        const stockData = response.data
        
        // æ›´æ–°è‚¡ç¥¨ä¿¡æ¯
        this.stockInfo = {
          code: this.selectedStock.code,
          name: stockData.name,
          currentPrice: stockData.price,
          open: stockData.open,
          high: stockData.high,
          low: stockData.low,
          priceChange: stockData.change,
          priceChangePercent: stockData.changePercent,
          volume: stockData.volume,
          amplitude: stockData.amplitude,
          turnoverRate: stockData.turnover
        }
        
        // æ›´æ–°è‚¡ç¥¨åç§°
        this.selectedStock.name = stockData.name
        
        // è‡ªåŠ¨è¯„ä¼°äº¤æ˜“æœºä¼š
        this.evaluateOpportunity()
      } catch (error) {
        console.error('è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥', error)
        this.$toast.error('è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥: ' + (error.response?.data?.detail || error.message))
        
        // TODO: å¼€å‘æœŸé—´ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        this.stockInfo = {
          code: this.selectedStock.code,
          name: 'ç¤ºä¾‹è‚¡ç¥¨',
          currentPrice: 10.50,
          open: 10.30,
          high: 10.80,
          low: 10.20,
          priceChange: 0.20,
          priceChangePercent: 1.94,
          volume: 1250000,
          amplitude: 5.8,
          turnoverRate: 1.5
        }
        this.selectedStock.name = 'ç¤ºä¾‹è‚¡ç¥¨'
      }
    },
    
    // è¯„ä¼°Täº¤æ˜“æœºä¼š
    async evaluateOpportunity() {
      if (!this.stockInfo.code || !this.selectedStock.basePosition) {
        this.$toast.warning('è¯·å…ˆé€‰æ‹©è‚¡ç¥¨å¹¶å¡«å†™åº•ä»“ä¿¡æ¯')
        return
      }
      
      try {
        const stockInfo = {
          code: this.stockInfo.code,
          name: this.stockInfo.name,
          current_price: this.stockInfo.currentPrice,
          open_price: this.stockInfo.open,
          intraday_high: this.stockInfo.high,
          intraday_low: this.stockInfo.low,
          avg_volume: this.stockInfo.volume * 0.8, // å‡è®¾å¹³å‡æˆäº¤é‡ä¸ºå½“å‰çš„80%
          current_volume: this.stockInfo.volume,
          base_position: parseInt(this.selectedStock.basePosition),
          base_cost: parseFloat(this.selectedStock.baseCost) || this.stockInfo.currentPrice
        }
        
        const response = await this.$http.post('/api/t-trading/evaluate-opportunity', stockInfo)
        this.opportunity = response.data
        
        // å¦‚æœæœ‰æœºä¼šï¼Œè‡ªåŠ¨è®¾ç½®äº¤æ˜“ç±»å‹å’Œå‚æ•°
        if (this.opportunity.has_opportunity) {
          if (this.opportunity.mode === 'positive') {
            this.tradeInfo.type = 'buy'
          } else {
            this.tradeInfo.type = 'sell'
          }
          
          this.tradeInfo.price = this.stockInfo.currentPrice
          this.tradeInfo.quantity = this.opportunity.suggested_quantity || 
                                   Math.floor(this.selectedStock.basePosition * 0.2)
        }
      } catch (error) {
        console.error('è¯„ä¼°Täº¤æ˜“æœºä¼šå¤±è´¥', error)
        this.$toast.error('è¯„ä¼°äº¤æ˜“æœºä¼šå¤±è´¥: ' + (error.response?.data?.detail || error.message))
        
        // TODO: å¼€å‘æœŸé—´ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        if (this.stockInfo.priceChange > 0) {
          // ä¸Šæ¶¨è¶‹åŠ¿ï¼Œæ¨¡æ‹ŸåTæœºä¼š
          this.opportunity = {
            has_opportunity: true,
            mode: 'negative',
            message: 'æ¥è¿‘æ—¥å†…é«˜ç‚¹ï¼Œå¯è€ƒè™‘åT(å…ˆå–)',
            suggested_quantity: Math.floor(this.selectedStock.basePosition * 0.2),
            volatility: this.stockInfo.amplitude / 100,
            current_position: 0.75,
            expected_cost_impact: {
              original_cost: parseFloat(this.selectedStock.baseCost) || this.stockInfo.currentPrice,
              new_cost: (parseFloat(this.selectedStock.baseCost) || this.stockInfo.currentPrice) * 0.995,
              cost_reduction: (parseFloat(this.selectedStock.baseCost) || this.stockInfo.currentPrice) * 0.005,
              reduction_percentage: 0.5
            }
          }
          this.tradeInfo.type = 'sell'
        } else {
          // ä¸‹è·Œè¶‹åŠ¿ï¼Œæ¨¡æ‹Ÿæ­£Tæœºä¼š
          this.opportunity = {
            has_opportunity: true,
            mode: 'positive',
            message: 'æ¥è¿‘æ—¥å†…ä½ç‚¹ï¼Œå¯è€ƒè™‘æ­£T(å…ˆä¹°)',
            suggested_quantity: Math.floor(this.selectedStock.basePosition * 0.2),
            volatility: this.stockInfo.amplitude / 100,
            current_position: 0.25,
            expected_cost_impact: {
              original_cost: parseFloat(this.selectedStock.baseCost) || this.stockInfo.currentPrice,
              new_cost: (parseFloat(this.selectedStock.baseCost) || this.stockInfo.currentPrice) * 0.995,
              cost_reduction: (parseFloat(this.selectedStock.baseCost) || this.stockInfo.currentPrice) * 0.005,
              reduction_percentage: 0.5
            }
          }
          this.tradeInfo.type = 'buy'
        }
        
        this.tradeInfo.price = this.stockInfo.currentPrice
        this.tradeInfo.quantity = this.opportunity.suggested_quantity
      }
    },
    
    // æäº¤äº¤æ˜“
    async submitTrade() {
      if (!this.isTrading) {
        this.$toast.warning('è¯·å…ˆå¼€å§‹äº¤æ˜“æ—¥')
        return
      }
      
      if (!this.tradeInfo.price || !this.tradeInfo.quantity) {
        this.$toast.warning('è¯·å¡«å†™å®Œæ•´çš„äº¤æ˜“ä¿¡æ¯')
        return
      }
      
      try {
        const tradeRequest = {
          stock_code: this.stockInfo.code,
          stock_name: this.stockInfo.name,
          price: parseFloat(this.tradeInfo.price),
          quantity: parseInt(this.tradeInfo.quantity),
          trade_type: this.tradeInfo.type,
          mode: this.opportunity.mode
        }
        
        const response = await this.$http.post('/api/t-trading/record-trade', tradeRequest)
        
        if (response.data && response.data.status === 'success') {
          this.$toast.success(response.data.message)
          
          // é‡æ–°åŠ è½½äº¤æ˜“å†å²
          this.loadTradingHistory()
          
          // é‡ç½®äº¤æ˜“è¡¨å•
          this.tradeInfo = {
            type: this.opportunity.mode === 'positive' ? 'buy' : 'sell',
            price: this.stockInfo.currentPrice,
            quantity: this.opportunity.suggested_quantity
          }
        }
      } catch (error) {
        console.error('æäº¤äº¤æ˜“å¤±è´¥', error)
        this.$toast.error('æäº¤äº¤æ˜“å¤±è´¥: ' + (error.response?.data?.detail || error.message))
      }
    },
    
    // åŠ è½½äº¤æ˜“å†å²
    async loadTradingHistory() {
      try {
        const response = await this.$http.get('/api/t-trading/trade-history?days=7')
        this.tradingHistory = response.data
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        this.updateDailyStats()
      } catch (error) {
        console.error('åŠ è½½äº¤æ˜“å†å²å¤±è´¥', error)
        
        // TODO: å¼€å‘æœŸé—´ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        this.tradingHistory = [
          {
            date: this.formatDateString(new Date()),
            stock_code: '600000',
            stock_name: 'æµ¦å‘é“¶è¡Œ',
            trade_type: 'complete',
            mode: 'positive',
            buy_price: 10.25,
            sell_price: 10.45,
            quantity: 200,
            profit: 40,
            status: 'success'
          },
          {
            date: this.formatDateString(new Date(Date.now() - 24 * 60 * 60 * 1000)),
            stock_code: '601318',
            stock_name: 'ä¸­å›½å¹³å®‰',
            trade_type: 'complete',
            mode: 'negative',
            buy_price: 38.10,
            sell_price: 38.95,
            quantity: 100,
            profit: 85,
            status: 'success'
          },
          {
            date: this.formatDateString(new Date(Date.now() - 48 * 60 * 60 * 1000)),
            stock_code: '000001',
            stock_name: 'å¹³å®‰é“¶è¡Œ',
            trade_type: 'buy_only',
            mode: 'positive',
            buy_price: 15.80,
            sell_price: 0,
            quantity: 300,
            profit: 0,
            status: 'pending'
          }
        ]
        
        this.updateDailyStats()
      }
    },
    
    // æ›´æ–°æ¯æ—¥ç»Ÿè®¡
    updateDailyStats() {
      const today = this.formatDateString(new Date())
      const todayTrades = this.tradingHistory.filter(trade => trade.date === today)
      
      this.dailyStats = {
        trades: todayTrades.length,
        successful: todayTrades.filter(trade => trade.status === 'success').length,
        profit: todayTrades.reduce((sum, trade) => sum + (trade.profit || 0), 0)
      }
    },
    
    // è·å–æœºä¼šæ–‡æœ¬
    getOpportunityText() {
      if (!this.opportunity || !this.opportunity.has_opportunity) {
        return 'æ— Täº¤æ˜“æœºä¼š'
      }
      
      return this.opportunity.mode === 'positive' ? 'æ­£Tæœºä¼š(å…ˆä¹°åå–)' : 'åTæœºä¼š(å…ˆå–åä¹°)'
    },
    
    // è·å–äº¤æ˜“æ¨¡å¼æ–‡æœ¬
    getTradeModeText(trade) {
      if (trade.trade_type === 'complete') {
        return trade.mode === 'positive' ? 'æ­£T' : 'åT'
      } else if (trade.trade_type === 'buy_only') {
        return 'ä¹°å…¥'
      } else if (trade.trade_type === 'sell_only') {
        return 'å–å‡º'
      }
      return '-'
    },
    
    // è·å–äº¤æ˜“çŠ¶æ€æ–‡æœ¬
    getTradeStatusText(status) {
      const statusMap = {
        'success': 'è·åˆ©',
        'failure': 'äºæŸ',
        'neutral': 'å¹³',
        'pending': 'å¾…å®Œæˆ'
      }
      return statusMap[status] || status
    },
    
    // Add to methods:
    executeTrade(tradeInfo) {
      // å°†AIæ¨èçš„äº¤æ˜“ä¿¡æ¯å¡«å……åˆ°äº¤æ˜“è¡¨å•
      this.tradeInfo.type = tradeInfo.trade_type;
      this.tradeInfo.price = tradeInfo.price;
      this.tradeInfo.quantity = tradeInfo.quantity;
      
      // å¯é€‰ï¼šè‡ªåŠ¨æäº¤äº¤æ˜“
      if (this.isTrading) {
        this.submitTrade();
      } else {
        this.$toast.warning('è¯·å…ˆå¼€å§‹äº¤æ˜“æ—¥');
      }
    },
    executeAIDecision(action) {
      if (!this.opportunity || !this.opportunity.has_opportunity || !this.stockInfo.code) {
        this.$toast.warning('æ— å¯ç”¨çš„Agentäº¤æ˜“å†³ç­–');
        return;
      }
      
      // æ£€æŸ¥äº¤æ˜“è´¦æˆ·è¿æ¥
      if (!this.isConnected) {
        this.$toast.warning('è¯·å…ˆè¿æ¥äº¤æ˜“è´¦æˆ·');
        return;
      }
      
      // æ£€æŸ¥äº¤æ˜“æ—¥æ˜¯å¦å¼€å§‹
      if (!this.tTradingTracker.todayDate) {
        this.$toast.warning('è¯·å…ˆå¼€å§‹äº¤æ˜“æ—¥');
        return;
      }
      
      // æ„å»ºäº¤æ˜“è¯·æ±‚
      const request = {
        stock_code: this.stockInfo.code,
        stock_name: this.stockInfo.name,
        price: this.stockInfo.current_price,
        quantity: this.opportunity.suggested_quantity,
        trade_type: action,
        mode: this.opportunity.mode
      };
      
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      uni.showModal({
        title: 'Agentäº¤æ˜“ç¡®è®¤',
        content: `ç¡®è®¤${action === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} ${this.stockInfo.name} ${this.opportunity.suggested_quantity}è‚¡ @ Â¥${this.stockInfo.current_price.toFixed(2)}ï¼Ÿ`,
        confirmText: 'ç¡®è®¤æ‰§è¡Œ',
        confirmColor: '#007aff',
        cancelText: 'å–æ¶ˆ',
        success: async (res) => {
          if (res.confirm) {
            try {
              uni.showLoading({
                title: 'æ‰§è¡Œäº¤æ˜“ä¸­...'
              });
              
              // æ‰§è¡Œäº¤æ˜“
              const result = await this.tTradingService.recordTrade(request);
              
              uni.hideLoading();
              
              if (result.status === 'success') {
                uni.showToast({
                  title: 'äº¤æ˜“å·²æ‰§è¡Œ',
                  icon: 'success'
                });
                
                // é‡æ–°åŠ è½½äº¤æ˜“å†å²
                this.loadTradeHistory();
                
                // æ›´æ–°æœºä¼šè¯„ä¼°ï¼ˆæ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼‰
                this.opportunity.executed = true;
                
              } else {
                uni.showToast({
                  title: result.message || 'æ‰§è¡Œå¤±è´¥',
                  icon: 'none'
                });
              }
            } catch (error) {
              uni.hideLoading();
              console.error('æ‰§è¡Œäº¤æ˜“å¤±è´¥:', error);
              uni.showToast({
                title: 'æ‰§è¡Œå¤±è´¥ï¼Œè¯·é‡è¯•',
                icon: 'none'
              });
            }
          }
        }
      });
    },
    getConfidenceClass(confidence) {
      if (confidence > 0.75) return 'high'
      if (confidence > 0.6) return 'medium'
      return 'low'
    }
  }
}
</script>

<style scoped>
.container {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.header {
  margin-bottom: 20px;
  text-align: center;
}

.title {
  font-size: 24px;
  font-weight: bold;
  color: #333;
}

.subtitle {
  font-size: 14px;
  color: #666;
  margin-top: 5px;
}

.control-panel {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}

.panel {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
  overflow: hidden;
}

.panel-title {
  background: #f5f7fa;
  padding: 12px 15px;
  font-weight: bold;
  color: #333;
  border-bottom: 1px solid #eaeaea;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-body {
  padding: 15px;
}

.field {
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
}

.field-row {
  margin-bottom: 15px;
  display: flex;
  align-items: center;
}

.field-label {
  flex: 0 0 100px;
  font-size: 14px;
  color: #666;
}

input[type="text"],
input[type="number"] {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #dcdfe6;
  border-radius: 4px;
}

.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.btn {
  padding: 8px 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  background: #409eff;
  color: white;
  transition: all 0.3s;
}

.btn:hover {
  opacity: 0.9;
}

.btn:disabled {
  background: #a0cfff;
  cursor: not-allowed;
}

.btn-warning {
  background: #e6a23c;
}

.btn-primary {
  background: #409eff;
  color: white;
}

.stock-selector {
  margin-bottom: 20px;
}

.price-box {
  display: flex;
  align-items: baseline;
  margin-bottom: 15px;
}

.current-price {
  font-size: 28px;
  font-weight: bold;
  margin-right: 10px;
}

.price-change {
  font-size: 14px;
}

.price-up {
  color: #f56c6c;
}

.price-down {
  color: #67c23a;
}

.market-info {
  border-top: 1px solid #eaeaea;
  padding-top: 15px;
}

.info-row {
  display: flex;
  gap: 20px;
  margin-bottom: 10px;
}

.info-item {
  flex: 1;
}

.info-label {
  font-size: 12px;
  color: #909399;
  margin-bottom: 5px;
  display: block;
}

.info-value {
  font-size: 14px;
  color: #303133;
}

.centered {
  text-align: center;
  padding: 20px;
  color: #909399;
}

.opportunity-result {
  margin-bottom: 15px;
}

.opportunity-status {
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 5px;
}

.opportunity-positive {
  color: #67c23a;
}

.opportunity-negative {
  color: #f56c6c;
}

.opportunity-none {
  color: #909399;
}

.opportunity-detail {
  font-size: 14px;
  color: #606266;
}

.opportunity-suggestion {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dashed #eaeaea;
}

.suggestion-item {
  flex: 1;
  min-width: 120px;
}

.suggestion-label {
  font-size: 12px;
  color: #909399;
  margin-bottom: 5px;
  display: block;
}

.suggestion-value {
  font-size: 14px;
  color: #303133;
  font-weight: bold;
}

.cost-impact {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dashed #eaeaea;
}

.impact-title {
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 10px;
}

.impact-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
}

.impact-label {
  font-size: 12px;
  color: #606266;
}

.impact-value {
  font-size: 12px;
  color: #303133;
}

.profit {
  color: #f56c6c;
}

.loss {
  color: #67c23a;
}

.trade-form {
  max-width: 500px;
  margin: 0 auto;
}

.radio-group {
  display: flex;
  gap: 20px;
}

.radio-label {
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
}

.actions {
  margin-top: 20px;
  justify-content: center;
}

.table-container {
  overflow-x: auto;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.history-table th,
.history-table td {
  border: 1px solid #ebeef5;
  padding: 8px 12px;
  text-align: center;
}

.history-table th {
  background-color: #f5f7fa;
  color: #606266;
  font-weight: 500;
}

.history-table tr:hover td {
  background-color: #f5f7fa;
}

.success {
  color: #67c23a;
}

.failure {
  color: #f56c6c;
}

.pending {
  color: #909399;
}

.refresh-btn {
  font-size: 12px;
  color: #409eff;
  cursor: pointer;
  font-weight: normal;
}

.refresh-btn:hover {
  text-decoration: underline;
}

.ai-badge {
  font-size: 12px;
  background-color: #409eff;
  color: white;
  padding: 2px 6px;
  border-radius: 3px;
  margin-left: 8px;
}

.confidence {
  font-weight: bold;
}

.confidence.high {
  color: #67c23a;
}

.confidence.medium {
  color: #e6a23c;
}

.confidence.low {
  color: #f56c6c;
}

.price-prediction {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dashed #eaeaea;
}

.prediction-title {
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 10px;
}

.prediction-content {
  display: flex;
  gap: 20px;
}

.prediction-item {
  flex: 1;
}

.prediction-label {
  font-size: 12px;
  color: #909399;
  margin-bottom: 5px;
  display: block;
}

.prediction-value {
  font-size: 14px;
  font-weight: bold;
}

.confidence-meter {
  width: 100%;
  height: 10px;
  background-color: #f0f0f0;
  border-radius: 5px;
  overflow: hidden;
}

.confidence-bar {
  height: 100%;
  background-color: #409eff;
}

.ai-icon {
  display: inline-block;
  width: 16px;
  height: 16px;
  background-color: white;
  border-radius: 50%;
  margin-right: 5px;
}

.result {
  margin-top: 15px;
}

.result-box {
  background-color: #fff;
  border: 1px solid #eaeaea;
  border-radius: 4px;
  padding: 15px;
}

.result-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.result-title {
  font-size: 16px;
  font-weight: bold;
}

.result-time {
  font-size: 12px;
  color: #909399;
}

.result-message {
  font-size: 14px;
  color: #303133;
  margin-bottom: 15px;
}

.result-details {
  margin-bottom: 15px;
}

.detail-item {
  margin-bottom: 5px;
}

.detail-label {
  font-size: 12px;
  color: #909399;
  margin-right: 10px;
}

.detail-value {
  font-size: 14px;
  color: #303133;
}

.ai-decision-panel {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dashed #eaeaea;
}

.ai-decision-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.ai-decision-icon {
  display: inline-block;
  width: 16px;
  height: 16px;
  background-color: white;
  border-radius: 50%;
  margin-right: 5px;
}

.ai-decision-title {
  font-size: 14px;
  font-weight: bold;
}

.ai-decision-body {
  margin-bottom: 10px;
}

.ai-decision-message {
  font-size: 14px;
  color: #303133;
}

.expected-impact {
  margin-bottom: 10px;
}

.impact-title {
  font-size: 12px;
  font-weight: bold;
}

.impact-detail {
  font-size: 14px;
  color: #606266;
}

.ai-decision-actions {
  text-align: right;
}

.action-button {
  padding: 8px 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  background: #409eff;
  color: white;
  transition: all 0.3s;
}

.action-button:hover {
  opacity: 0.9;
}

.action-button.primary {
  background: #409eff;
}

.icon {
  margin-right: 5px;
}
</style> 
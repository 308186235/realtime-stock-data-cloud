# PIN码安全功能测试计划

## 测试环境

- Android 设备 
- iOS 设备
- 不同系统版本的UniApp模拟器

## 功能测试

### 1. 初始化与存储迁移

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 应用首次启动 | 1. 清除应用数据<br>2. 启动应用 | 1. 安全服务初始化<br>2. 无PIN码存在<br>3. 安全设置正确加载 |
| 从旧版本迁移 | 1. 在存储中预先设置旧格式PIN码(tradePINCode)<br>2. 启动应用 | 1. 应用自动迁移旧PIN码到新格式(appPINCode)<br>2. 旧数据被删除<br>3. 日志显示"迁移成功" |
| 缓存功能 | 1. 启动应用<br>2. 多次短时间内查询安全设置 | 1. 第一次查询从存储读取<br>2. 之后的查询使用缓存<br>3. 日志显示"使用缓存的安全设置" |

### 2. PIN码设置

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 首次设置PIN码 | 1. 打开安全设置页面<br>2. 点击设置密码<br>3. 输入6位数字PIN码<br>4. 确认PIN码 | 1. PIN码成功存储<br>2. hasPINCode标志设为true<br>3. usePINCode标志设为true<br>4. 显示成功提示 |
| 更改PIN码(验证旧码) | 1. 打开安全设置页面<br>2. 点击修改密码<br>3. 输入正确的旧PIN码<br>4. 输入新的PIN码<br>5. 确认新PIN码 | 1. 验证旧PIN码成功<br>2. 新PIN码成功存储<br>3. 设置状态保持不变<br>4. 显示成功提示 |
| 输入错误的旧PIN码 | 1. 打开安全设置页面<br>2. 点击修改密码<br>3. 输入错误的旧PIN码 | 显示"密码错误"提示并返回验证界面 |
| 两次输入的PIN码不一致 | 1. 打开安全设置页面<br>2. 点击设置/修改密码<br>3. (如有需要先验证旧密码)<br>4. 输入新PIN码<br>5. 确认时输入不同的PIN码 | 显示"两次输入的密码不一致"提示并清空输入 |
| 密码格式验证 | 1. 打开安全设置页面<br>2. 点击设置/修改密码<br>3. 尝试输入少于6位的PIN码 | PIN码输入界面应限制必须输入6位数字 |

### 3. PIN码解锁功能

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 启用PIN码解锁 | 1. 打开安全设置页面<br>2. 开启密码解锁开关 | 1. usePINCode标志设为true<br>2. 设置成功存储<br>3. 开关状态显示打开 |
| 禁用PIN码解锁 | 1. 打开安全设置页面<br>2. 关闭密码解锁开关 | 1. usePINCode标志设为false<br>2. 设置成功存储<br>3. 开关状态显示关闭 |
| 应用锁定解锁 | 1. 启用PIN码解锁<br>2. 退出并重新打开应用<br>3. 在锁屏界面输入正确PIN码 | 验证成功后应用解锁并进入主界面 |
| 多次错误尝试 | 1. 启用PIN码解锁<br>2. 退出并重新打开应用<br>3. 在锁屏界面多次输入错误PIN码 | 1. 每次都显示"密码错误"提示<br>2. 清空输入<br>3. (可选)达到次数限制时暂时锁定 |
| 应用完全退出后锁定 | 1. 启用PIN码解锁<br>2. 使用返回键或任务管理器完全退出应用<br>3. 重新启动应用 | 1. 应用启动后显示锁屏界面<br>2. 需验证PIN码后才能使用应用<br>3. 日志显示"检测到强制锁定标志" |

### 4. 交易PIN码确认

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 使用PIN码确认交易 | 1. 启用交易密码验证<br>2. 发起交易<br>3. 在确认弹窗中输入正确PIN码 | 1. PIN码验证成功<br>2. 交易执行<br>3. 显示交易成功提示 |
| 交易验证失败 | 1. 启用交易密码验证<br>2. 发起交易<br>3. 在确认弹窗中输入错误PIN码 | 1. 显示"交易密码错误"提示<br>2. 交易取消<br>3. 返回交易页面 |
| 取消交易确认 | 1. 启用交易密码验证<br>2. 发起交易<br>3. 出现确认弹窗时点击取消 | 1. 确认弹窗关闭<br>2. 交易取消<br>3. 返回交易页面 |

## 安全测试

### 1. 存储安全

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| PIN码加密验证 | 1. 设置PIN码<br>2. 查看存储数据 | 1. PIN码使用加密存储<br>2. 不能直接读取原始PIN码 |
| 设备绑定 | 1. 设置PIN码<br>2. 导出数据<br>3. 在不同设备上导入 | PIN码在原设备上可用，在新设备上验证失败 |
| 清除缓存后验证 | 1. 设置PIN码<br>2. 调用clearSettingsCache()<br>3. 重新获取设置并验证PIN码 | 1. 缓存被清除<br>2. 从存储重新读取设置<br>3. PIN码验证仍然成功 |

### 2. 锁定机制

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 应用后台锁定 | 1. 启用PIN码锁定<br>2. 使应用进入后台30分钟<br>3. 重新打开应用 | 应用显示锁屏界面，要求PIN码验证 |
| 手动锁定 | 1. 启用PIN码锁定<br>2. 在设置页面执行"锁定应用"操作<br>3. 尝试操作应用 | 应用立即锁定，显示锁屏界面 |
| 会话过期锁定 | 1. 启用PIN码锁定<br>2. 修改代码强制会话过期<br>3. 尝试操作应用 | 会话过期后应用锁定，要求重新验证 |
| 强制锁定标志持久化 | 1. 启用PIN码锁定<br>2. 完全关闭应用<br>3. 模拟断电或强制重启<br>4. 重新启动应用 | 强制锁定标志被正确恢复，应用仍处于锁定状态 |

## 错误恢复测试

### 1. 数据异常

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 损坏的设置数据 | 1. 修改securitySettings为无效数据<br>2. 启动应用 | 1. 检测到异常数据<br>2. 重置为默认设置<br>3. 日志显示"安全设置格式无效，重置为默认值" |
| 损坏的PIN码数据 | 1. 修改appPINCode为无效加密数据<br>2. 启动应用<br>3. 尝试验证PIN码 | 1. 验证失败<br>2. 可能要求重新设置PIN码<br>3. 日志显示相关错误 |
| 存储不可用 | 1. 模拟存储操作失败<br>2. 尝试设置/验证PIN码 | 1. 显示合适的错误消息<br>2. 提供备选验证方式<br>3. 日志记录具体失败原因 |

## 性能测试

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| PIN码验证响应时间 | 测量PIN码验证所需时间 | 验证时间应在1秒内完成 |
| 频繁存储操作 | 短时间内反复切换PIN码开关状态 | 1. 通过缓存减少存储操作<br>2. 不应出现性能下降<br>3. 设置应正确保存 |

## 兼容性测试

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 不同系统版本 | 在不同版本的Android和iOS上测试PIN码功能 | PIN码功能在所有支持的版本上正常工作 |
| 不同设备存储 | 在不同厂商的设备上测试存储和加密功能 | 存储和加密在各设备上一致工作 |
| 应用更新 | 1. 在旧版应用中设置PIN码<br>2. 更新到新版本<br>3. 验证PIN码功能 | 更新后PIN码设置和验证功能正常工作 |

## 多种测试场景

### 1. 常见使用场景

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 完整PIN码流程 | 1. 设置PIN码<br>2. 退出应用<br>3. 重新启动<br>4. 使用PIN码解锁<br>5. 修改PIN码<br>6. 验证新PIN码 | 整个流程顺利完成，没有错误 |
| 设置-禁用-重新设置 | 1. 设置PIN码<br>2. 关闭PIN码解锁<br>3. 重新开启<br>4. 再次设置PIN码 | 所有状态变化正确保存和显示 |

### 2. 边缘场景

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 网络中断 | 在无网络环境下测试PIN码功能 | PIN码功能正常工作，不依赖网络 |
| 低存储空间 | 在设备存储空间极少的情况下测试 | 应用处理存储空间不足的情况并提供提示 |
| 快速操作 | 快速连续执行多个PIN码相关操作 | 应用正常响应，不出现状态错误或崩溃 |
| 电池耗尽场景 | 1. 启用PIN码<br>2. 使用设备至电池耗尽自动关机<br>3. 充电后重新启动<br>4. 打开应用 | 应用应正确锁定并要求PIN码验证 |

## 日志记录检查

| 测试用例 | 步骤 | 预期结果 |
|---------|------|----------|
| 日志完整性 | 执行各种PIN码操作并检查日志 | 1. 每个关键操作都有日志记录<br>2. 日志详细描述操作结果<br>3. 敏感信息不应明文记录 |
| 错误日志 | 模拟各种错误情况并检查日志 | 1. 错误原因被清晰记录<br>2. 包含足够的信息用于调试<br>3. 不泄露PIN码等敏感信息 | 
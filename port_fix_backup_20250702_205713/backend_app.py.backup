import os
import logging
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.middleware.cors import CORSMiddleware
import uvicorn
from dotenv import load_dotenv
from apscheduler.schedulers.background import BackgroundScheduler
import json

# Internal imports
from config import settings
from api.routers import strategy, portfolio, stock, ai, backtest, market_tracker, auto_trader
from api.routers.enhanced_analysis import router as enhanced_analysis_router
from api.routers.supabase_portfolio import router as supabase_portfolio_router
from api.routers.realtime_stock_simple import router as realtime_stock_router
from api.routers.realtime_data_api import router as realtime_data_router
from api.routers.technical_indicators_api import router as technical_indicators_router
from api.routers.chagubang_api import router as chagubang_router  # èŒ¶è‚¡å¸®API
from api.routers.agent_analysis import router as agent_analysis_router  # Agentåˆ†æAPI
from api.routers.account_balance import router as account_balance_router  # è´¦æˆ·ä½™é¢API
from api.routers.config_api import router as config_router  # é…ç½®ç®¡ç†API
from api.cloud_local_trading_api import router as cloud_local_router  # äº‘ç«¯æœ¬åœ°äº¤æ˜“API
from api.websocket_routes import router as websocket_router  # WebSocketè·¯ç”±
from api.trading_api import router as trading_router
from api.t_trading_api import router as t_trading_router

# å¯¼å…¥æœåŠ¡ç»„ä»¶
from services.unified_websocket_manager import UnifiedWebSocketManager
from services.data_flow_manager import DataFlowManager
from api.test_endpoint import router as test_router  # ç€µç…å†å¨´å¬­ç˜¯ç’ºîˆœæ•±
from api.end_of_day_selection_api import router as eod_selection_router  # ç€µç…å†çå‰§æ´é–«å¤å‚ç’ºîˆœæ•±
from services.websocket_manager import ConnectionManager
from services.market_data_service import MarketDataService
from services.trading_service import TradingService
from services.ai_service import AIService
from services.backtest_service import BacktestService
from services.market_tracker_service import MarketTrackerService
from services.rapid_response_service import RapidResponseService
from services.auto_trader_service import AutoTraderService
from services.ai_t_trading_service import AITTradingService
from services.end_of_day_selection_service import EndOfDaySelectionService
from services.realtime_data_manager import realtime_data_manager
from strategies import StrategyFactory  # Import the StrategyFactory

# Load environment variables
load_dotenv()

# Configure logging
os.makedirs("logs", exist_ok=True)  # ç¡®ä¿logsç›®å½•å­˜åœ¨
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler("logs/app.log"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# Create FastAPI application
app = FastAPI(
    title="Stock Trading System API",
    description="API for automatic stock trading system",
    version="1.0.0"
)

# Configure CORS
origins = [
    "https://aigupiao.me",
    "https://api.aigupiao.me",
    "https://app.aigupiao.me",
    "https://mobile.aigupiao.me",
    "https://admin.aigupiao.me",
    "http://localhost:8080",
    "http://localhost:3000",
    "capacitor://localhost",
    "ionic://localhost"
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Initialize services
market_data_service = MarketDataService()
trading_service = TradingService()
ai_service = AIService()
backtest_service = BacktestService()
auto_trader_service = AutoTraderService()
market_tracker_service = MarketTrackerService(ai_service=ai_service, auto_trader_service=auto_trader_service)
rapid_response_service = RapidResponseService()
ws_manager = ConnectionManager()
ai_t_trading_service = AITTradingService()  # Initialize AI T Trading Service
eod_selection_service = EndOfDaySelectionService()  # Initialize EOD Selection Service

# Basic health check endpoint
@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    return {
        "status": "healthy",
        "message": "APP APIæœåŠ¡æ­£å¸¸",
        "timestamp": datetime.now().isoformat(),
        "api_version": "1.0",
        "app_support": True,
        "service": "stock-trading-backend"
    }

@app.get("/api/health")
async def api_health_check():
    """APIå¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    return {
        "status": "healthy",
        "message": "APP APIæœåŠ¡æ­£å¸¸",
        "timestamp": datetime.now().isoformat(),
        "api_version": "1.0",
        "app_support": True,
        "service": "stock-trading-backend"
    }

# Include routers - Updated to use Supabase-integrated routers
app.include_router(strategy.router, prefix="/api/strategy", tags=["strategy"])
app.include_router(portfolio.router, prefix="/api/portfolio", tags=["portfolio"])  # Updated with Supabase
app.include_router(supabase_portfolio_router, prefix="/api/supabase", tags=["supabase-portfolio"])
app.include_router(realtime_stock_router, prefix="/api/realtime", tags=["realtime-stock"])
app.include_router(realtime_data_router, prefix="/api/realtime-data", tags=["realtime-data"])  # æ–°çš„å®æ—¶æ•°æ®API
app.include_router(technical_indicators_router, prefix="/api/technical", tags=["technical-indicators"])  # æŠ€æœ¯æŒ‡æ ‡API
app.include_router(chagubang_router, prefix="/api/chagubang", tags=["chagubang"])  # èŒ¶è‚¡å¸®å®æ—¶æ•°æ®API
app.include_router(agent_analysis_router, prefix="/api/agent-analysis", tags=["agent-analysis"])  # Agentåˆ†æAPI
app.include_router(account_balance_router, prefix="/api/account-balance", tags=["account-balance"])  # è´¦æˆ·ä½™é¢API
app.include_router(config_router, prefix="/api", tags=["config"])  # é…ç½®ç®¡ç†API
app.include_router(cloud_local_router, prefix="/api/cloud-local", tags=["cloud-local"])  # äº‘ç«¯æœ¬åœ°äº¤æ˜“API
app.include_router(websocket_router, prefix="/ws", tags=["websocket"])  # WebSocketè·¯ç”±
app.include_router(stock.router, prefix="/api/stock", tags=["stock"])  # Updated with Supabase
app.include_router(ai.router, prefix="/api/ai", tags=["ai"])
app.include_router(backtest.router, prefix="/api/backtest", tags=["backtest"])
app.include_router(market_tracker.router, prefix="/api/market-tracker", tags=["market-tracker"])
app.include_router(auto_trader.router, prefix="/api/auto-trader", tags=["auto-trader"])
app.include_router(trading_router, prefix="/api", tags=["trading"])
app.include_router(t_trading_router, tags=["t-trading"])
app.include_router(test_router, tags=["å¨´å¬­ç˜¯"])  # å¨‰ã„¥å”½å¨´å¬­ç˜¯ç’ºîˆœæ•±
app.include_router(eod_selection_router, tags=["çå‰§æ´é–«å¤å‚"])  # å¨‰ã„¥å”½çå‰§æ´é–«å¤å‚ç’ºîˆœæ•±

# WebSocket connection for real-time data
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await ws_manager.connect(websocket)
    try:
        while True:
            data = await websocket.receive_text()
            # Process received data
            logger.info(f"Received data: {data}")
            
            # Here we would process commands from the frontend
            # For example, subscribing to specific stock updates
            
    except WebSocketDisconnect:
        ws_manager.disconnect(websocket)

# WebSocket connection for rapid response service
@app.websocket("/rapid-ws/{client_id}")
async def rapid_websocket_endpoint(websocket: WebSocket, client_id: str):
    await websocket.accept()
    try:
        # å¨‰ã„¥å”½WebSocketæ©ç‚´å¸´
        await rapid_response_service.register_websocket(client_id, websocket)
        
        # é™æˆ¦â‚¬ä½ºâ€˜ç’ã‚†ç§·é­?
        await websocket.send_json({
            "type": "connection",
            "status": "connected",
            "client_id": client_id,
            "message": "å®¸èŒ¶ç¹›éºãƒ¥åŸŒè¹‡î‚¦â‚¬ç†·æ·æ´æ—€æ¹‡é”?"
        })
        
        # é™æˆ¦â‚¬ä½¹æ¸¶æ©æˆ æ®‘æ·‡å½¿
        recent_signals = await rapid_response_service.get_recent_signals(limit=5)
        if recent_signals:
            await websocket.send_json({
                "type": "recent_signals",
                "signals": recent_signals
            })
        
        # æ¾¶å‹­æ‚Šé‰ãƒ¨åšœç€¹ãˆ¡åŸ›ç»”îˆœæ®‘å¨‘å Ÿä¼…
        while True:
            data = await websocket.receive_text()
            try:
                message = json.loads(data)
                
                # éè§„åµå¨‘å Ÿä¼…ç»«è¯²ç€·æ¾¶å‹­æ‚Š
                if message.get("type") == "quick_update":
                    # æ¾¶å‹­æ‚Šè¹‡î‚¦â‚¬ç†¸æ´¿é‚æ‹Œî‡¬å§¹?                    if "tracker_id" in message:
                        tracker_id = message["tracker_id"]
                        # é‘¾å³°å½‡ç¼‚æ’³ç“¨éç‰ˆåµé´æ ¨å¢½ç›å±½æ©é–«ç†¸æ´¿é‚?                        cached_data = await rapid_response_service.get_cached_data(f"tracker_{tracker_id}")
                        
                        if cached_data:
                            # é™æˆ¦â‚¬ä½ºç´¦ç€›æ¨»æšŸé¹?
                            await websocket.send_json({
                                "type": "update",
                                "source": "cache",
                                "data": cached_data
                            })
                        else:
                            # æ‰§è¡Œè¹‡î‚¦â‚¬ç†¸æ´¿é‚æ¿è‹Ÿç¼‚æ’³ç“¨ç¼æ’´ç‰
                            result = await market_tracker_service.update_tracker(tracker_id)
                            await rapid_response_service.cache_data(f"tracker_{tracker_id}", result)
                            
                            # é™æˆ¦â‚¬ä½¹æ´¿é‚æ‰®ç²¨é‹?
                            await websocket.send_json({
                                "type": "update",
                                "source": "fresh",
                                "data": result
                            })
                
                elif message.get("type") == "process_signal":
                    # æ¾¶å‹­æ‚Šæ·‡å½¿ç’‡é”‹çœ°
                    if "signal" in message:
                        signal_data = message["signal"]
                        result = await rapid_response_service.process_trading_signal(signal_data)
                        
                        # é™æˆ¦â‚¬ä½¸î˜©éå—™ç²¨é‹?
                        await websocket.send_json({
                            "type": "signal_processed",
                            "result": result
                        })
                
            except json.JSONDecodeError:
                logger.error(f"éƒçŠ³æ™¥é¨å‡§SONå¨‘å Ÿä¼…: {data}")
            except Exception as e:
                logger.error(f"æ¾¶å‹­æ‚ŠWebSocketå¨‘å Ÿä¼…éƒè·ºåš­é–¿? {e}")
                await websocket.send_json({
                    "type": "error",
                    "message": str(e)
                })
    
    except WebSocketDisconnect:
        # å¨‰ã„©æ”¢WebSocketæ©ç‚´å¸´
        await rapid_response_service.unregister_websocket(client_id)
        logger.info(f"WebSocketç€¹ãˆ¡åŸ›ç»”îˆ›æŸ‡å¯®â‚¬æ©ç‚´å¸´: {client_id}")
    
    except Exception as e:
        logger.error(f"WebSocketæ¾¶å‹­æ‚Šéƒè·ºåš­é–¿? {e}")
        try:
            # å¨‰ã„©æ”¢WebSocketæ©ç‚´å¸´
            await rapid_response_service.unregister_websocket(client_id)
        except:
            pass

@app.on_event("startup")
async def startup_event():
    logger.info("Starting up the application...")

    # æš‚æ—¶æ³¨é‡Šæ‰å®šæ—¶ä»»åŠ¡ï¼Œé¿å…å¯åŠ¨é”™è¯¯
    # TODO: ä¿®å¤MarketDataServiceå’Œå…¶ä»–æœåŠ¡çš„æ–¹æ³•

    logger.info("Application startup completed")

@app.on_event("shutdown")
async def shutdown_event():
    logger.info("Shutting down the application...")
    
    # Stop the EOD selection scheduler
    await eod_selection_service.stop_scheduler()
    logger.info("End-of-day selection scheduler stopped")


app.include_router(enhanced_analysis_router, prefix="/api/enhanced-analysis", tags=["enhanced-analysis"])

# åº”ç”¨å¯åŠ¨äº‹ä»¶
@app.on_event("startup")
async def startup_event():
    """åº”ç”¨å¯åŠ¨æ—¶çš„åˆå§‹åŒ–"""
    try:
        logger.info("ğŸš€ åº”ç”¨å¯åŠ¨ä¸­...")

        # åˆå§‹åŒ–WebSocketç®¡ç†å™¨
        global websocket_manager, data_flow_manager
        websocket_manager = UnifiedWebSocketManager()

        # è®¾ç½®WebSocketç®¡ç†å™¨åˆ°ç›¸å…³æ¨¡å—
        try:
            from api.websocket_routes import set_websocket_manager
            from api.cloud_local_trading_api import set_websocket_manager as set_cloud_local_manager
            set_websocket_manager(websocket_manager)
            set_cloud_local_manager(websocket_manager)
            logger.info("âœ… WebSocketç®¡ç†å™¨å·²åˆå§‹åŒ–")
        except Exception as e:
            logger.warning(f"âš ï¸ WebSocketç®¡ç†å™¨è®¾ç½®å¤±è´¥: {e}")

        # åˆå§‹åŒ–æ•°æ®æµç®¡ç†å™¨
        try:
            config = {
                "chagubang_host": "l1.chagubang.com",
                "chagubang_port": 6380,
                "chagubang_token": "QT_wat5QfcJ6N9pDZM5",
                "enable_beijing_exchange": False,
                "analysis_interval": 40
            }
            data_flow_manager = DataFlowManager(config, websocket_manager)
            logger.info("âœ… æ•°æ®æµç®¡ç†å™¨å·²åˆå§‹åŒ–")
        except Exception as e:
            logger.warning(f"âš ï¸ æ•°æ®æµç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: {e}")

        # å¯åŠ¨å®æ—¶æ•°æ®ç®¡ç†å™¨
        await realtime_data_manager.start()
        logger.info("âœ… å®æ—¶æ•°æ®ç®¡ç†å™¨å·²å¯åŠ¨")

        # å¯åŠ¨åŸæœ‰çš„å®æ—¶æ•°æ®æ¨¡æ‹Ÿï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
        try:
            from api.routers.realtime_stock_simple import start_simulation
            await start_simulation()
            logger.info("âœ… å¤‡ç”¨å®æ—¶æ•°æ®æ¨¡æ‹Ÿå·²å¯åŠ¨")
        except Exception as e:
            logger.warning(f"âš ï¸ å¤‡ç”¨å®æ—¶æ•°æ®æ¨¡æ‹Ÿå¯åŠ¨å¤±è´¥: {str(e)}")

        logger.info("ğŸ‰ åº”ç”¨å¯åŠ¨å®Œæˆ")

    except Exception as e:
        logger.error(f"âŒ å¯åŠ¨äº‹ä»¶å¤±è´¥: {str(e)}")

@app.on_event("shutdown")
async def shutdown_event():
    """åº”ç”¨å…³é—­æ—¶çš„æ¸…ç†"""
    try:
        # åœæ­¢å®æ—¶æ•°æ®ç®¡ç†å™¨
        await realtime_data_manager.stop()
        logger.info("å®æ—¶æ•°æ®ç®¡ç†å™¨å·²åœæ­¢")

        # åœæ­¢åŸæœ‰çš„å®æ—¶æ•°æ®æ¨¡æ‹Ÿ
        try:
            from api.routers.realtime_stock_simple import stop_simulation
            await stop_simulation()
            logger.info("å¤‡ç”¨å®æ—¶æ•°æ®æ¨¡æ‹Ÿå·²åœæ­¢")
        except Exception as e:
            logger.warning(f"å¤‡ç”¨å®æ—¶æ•°æ®æ¨¡æ‹Ÿåœæ­¢å¤±è´¥: {str(e)}")

    except Exception as e:
        logger.error(f"å…³é—­äº‹ä»¶å¤±è´¥: {str(e)}")

if __name__ == "__main__":
    import uvicorn
    import os
    PORT = int(os.getenv("PORT", 8000))
    uvicorn.run(
        "app:app",
        host="0.0.0.0",
        port=PORT,
        log_level="info",
        access_log=True
    )


#!/usr/bin/env python3
"""
æœ¬åœ°Agentåç«¯æœåŠ¡å™¨
æ›¿ä»£æ— æ³•è®¿é—®çš„Cloudflare Workerï¼Œæä¾›å®Œæ•´çš„Agentåˆ†æåŠŸèƒ½
"""

import json
import time
import random
from datetime import datetime
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import uvicorn

app = FastAPI(title="æœ¬åœ°Agentåç«¯", version="1.0.0")

# æ·»åŠ CORSæ”¯æŒ
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class LocalAgentBackend:
    """æœ¬åœ°Agentåç«¯"""
    
    def __init__(self):
        self.version = "1.0.0"
        self.start_time = datetime.now()
        self.request_count = 0
        
    def generate_agent_analysis(self):
        """ç”ŸæˆAgentåˆ†ææ•°æ®"""
        self.request_count += 1
        
        # æ¨¡æ‹Ÿå®æ—¶å¸‚åœºåˆ†æ
        market_sentiments = ["bullish", "bearish", "neutral"]
        trends = ["upward", "downward", "sideways"]
        
        # ç”Ÿæˆæ¨èè‚¡ç¥¨
        stock_recommendations = [
            {
                "action": "buy",
                "stock_code": "000001",
                "stock_name": "å¹³å®‰é“¶è¡Œ",
                "reason": "æŠ€æœ¯æŒ‡æ ‡æ˜¾ç¤ºçªç ´å…³é”®é˜»åŠ›ä½ï¼Œæˆäº¤é‡æ”¾å¤§",
                "confidence": round(random.uniform(0.7, 0.9), 2),
                "target_price": round(random.uniform(13.0, 14.0), 2),
                "current_price": round(random.uniform(12.8, 13.2), 2),
                "stop_loss": round(random.uniform(12.0, 12.5), 2)
            },
            {
                "action": "hold",
                "stock_code": "000002",
                "stock_name": "ä¸‡ç§‘A",
                "reason": "æ¨ªç›˜æ•´ç†ä¸­ï¼Œç­‰å¾…æ–¹å‘é€‰æ‹©",
                "confidence": round(random.uniform(0.6, 0.8), 2),
                "target_price": round(random.uniform(19.5, 20.5), 2),
                "current_price": round(random.uniform(19.2, 19.8), 2),
                "stop_loss": round(random.uniform(18.5, 19.0), 2)
            },
            {
                "action": "sell",
                "stock_code": "600036",
                "stock_name": "æ‹›å•†é“¶è¡Œ",
                "reason": "çŸ­æœŸè·åˆ©äº†ç»“ï¼ŒæŠ€æœ¯æŒ‡æ ‡æ˜¾ç¤ºè¶…ä¹°",
                "confidence": round(random.uniform(0.7, 0.85), 2),
                "target_price": round(random.uniform(42.0, 43.0), 2),
                "current_price": round(random.uniform(42.5, 43.5), 2),
                "stop_loss": round(random.uniform(44.0, 45.0), 2)
            }
        ]
        
        return {
            "success": True,
            "data": {
                "timestamp": datetime.now().isoformat(),
                "market_sentiment": random.choice(market_sentiments),
                "confidence_score": round(random.uniform(0.7, 0.9), 2),
                "recommendations": stock_recommendations,
                "market_analysis": {
                    "trend": random.choice(trends),
                    "volatility": random.choice(["low", "medium", "high"]),
                    "volume": random.choice(["low", "normal", "high"]),
                    "risk_level": random.choice(["low", "medium", "high"])
                },
                "performance_metrics": {
                    "total_trades": random.randint(100, 200),
                    "win_rate": round(random.uniform(0.6, 0.8), 2),
                    "profit_loss": round(random.uniform(5000, 15000), 2),
                    "max_drawdown": round(random.uniform(-3000, -1000), 2),
                    "sharpe_ratio": round(random.uniform(1.2, 2.0), 2)
                },
                "technical_indicators": {
                    "rsi": round(random.uniform(30, 70), 1),
                    "macd": round(random.uniform(-0.5, 0.5), 3),
                    "bollinger_position": round(random.uniform(0.2, 0.8), 2),
                    "volume_ratio": round(random.uniform(0.8, 1.5), 2)
                },
                "risk_assessment": {
                    "portfolio_risk": random.choice(["low", "medium", "high"]),
                    "market_risk": random.choice(["low", "medium", "high"]),
                    "liquidity_risk": random.choice(["low", "medium"]),
                    "concentration_risk": random.choice(["low", "medium", "high"])
                }
            }
        }
    
    def generate_account_balance(self):
        """ç”Ÿæˆè´¦æˆ·ä½™é¢æ•°æ®"""
        return {
            "success": True,
            "data": {
                "account_info": {
                    "account_id": "LOCAL_AGENT_001",
                    "account_name": "æœ¬åœ°Agentäº¤æ˜“è´¦æˆ·",
                    "account_type": "æ¨¡æ‹Ÿè‚¡ç¥¨è´¦æˆ·",
                    "status": "æ­£å¸¸"
                },
                "balance": {
                    "total_assets": round(random.uniform(120000, 130000), 2),
                    "available_cash": round(random.uniform(20000, 30000), 2),
                    "frozen_cash": round(random.uniform(1000, 2000), 2),
                    "market_value": round(random.uniform(90000, 110000), 2),
                    "total_profit_loss": round(random.uniform(5000, 15000), 2),
                    "profit_loss_percent": round(random.uniform(5, 12), 2)
                },
                "positions": [
                    {
                        "stock_code": "000001",
                        "stock_name": "å¹³å®‰é“¶è¡Œ",
                        "quantity": 1000,
                        "cost_price": 12.50,
                        "current_price": round(random.uniform(13.0, 13.5), 2),
                        "market_value": round(1000 * random.uniform(13.0, 13.5), 2),
                        "profit_loss": round(1000 * (random.uniform(13.0, 13.5) - 12.50), 2),
                        "profit_loss_percent": round((random.uniform(13.0, 13.5) - 12.50) / 12.50 * 100, 2)
                    },
                    {
                        "stock_code": "000002",
                        "stock_name": "ä¸‡ç§‘A",
                        "quantity": 500,
                        "cost_price": 19.80,
                        "current_price": round(random.uniform(19.5, 20.2), 2),
                        "market_value": round(500 * random.uniform(19.5, 20.2), 2),
                        "profit_loss": round(500 * (random.uniform(19.5, 20.2) - 19.80), 2),
                        "profit_loss_percent": round((random.uniform(19.5, 20.2) - 19.80) / 19.80 * 100, 2)
                    }
                ],
                "timestamp": datetime.now().isoformat()
            }
        }

# åˆ›å»ºåç«¯å®ä¾‹
backend = LocalAgentBackend()

@app.get("/")
async def root():
    """æ ¹è·¯å¾„"""
    return {
        "message": "æœ¬åœ°Agentåç«¯æœåŠ¡å™¨",
        "version": backend.version,
        "status": "running",
        "uptime": str(datetime.now() - backend.start_time),
        "request_count": backend.request_count,
        "endpoints": [
            "GET / - æœåŠ¡å™¨ä¿¡æ¯",
            "GET /health - å¥åº·æ£€æŸ¥",
            "GET /api/agent-analysis - Agentåˆ†æ",
            "GET /api/account-balance - è´¦æˆ·ä½™é¢",
            "GET /api/market-data - å¸‚åœºæ•°æ®"
        ],
        "timestamp": datetime.now().isoformat()
    }

@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥"""
    return {
        "status": "healthy",
        "version": backend.version,
        "uptime": str(datetime.now() - backend.start_time),
        "request_count": backend.request_count,
        "timestamp": datetime.now().isoformat()
    }

@app.get("/api/agent-analysis")
async def get_agent_analysis():
    """è·å–Agentåˆ†æ"""
    return backend.generate_agent_analysis()

@app.get("/api/account-balance")
async def get_account_balance():
    """è·å–è´¦æˆ·ä½™é¢"""
    return backend.generate_account_balance()

@app.get("/api/market-data")
async def get_market_data():
    """è·å–å¸‚åœºæ•°æ®"""
    return {
        "success": True,
        "data": {
            "market_status": "open",
            "timestamp": datetime.now().isoformat(),
            "indices": {
                "shanghai": {
                    "value": round(random.uniform(3200, 3300), 2),
                    "change": round(random.uniform(-20, 20), 2),
                    "change_percent": round(random.uniform(-0.8, 0.8), 2)
                },
                "shenzhen": {
                    "value": round(random.uniform(11000, 11500), 2),
                    "change": round(random.uniform(-50, 50), 2),
                    "change_percent": round(random.uniform(-0.6, 0.6), 2)
                }
            },
            "hot_stocks": [
                {"code": "000001", "name": "å¹³å®‰é“¶è¡Œ", "price": round(random.uniform(13.0, 13.5), 2), "change_percent": round(random.uniform(-3, 3), 2)},
                {"code": "000002", "name": "ä¸‡ç§‘A", "price": round(random.uniform(19.5, 20.2), 2), "change_percent": round(random.uniform(-2, 2), 2)},
                {"code": "600036", "name": "æ‹›å•†é“¶è¡Œ", "price": round(random.uniform(42.0, 43.5), 2), "change_percent": round(random.uniform(-1, 1), 2)}
            ]
        }
    }

if __name__ == "__main__":
    print("ğŸ¤– å¯åŠ¨æœ¬åœ°Agentåç«¯æœåŠ¡å™¨...")
    print("=" * 50)
    print("ğŸŒ æœåŠ¡åœ°å€: http://localhost:9999")
    print("ğŸ“‹ APIæ–‡æ¡£: http://localhost:9999/docs")
    print("ğŸ”§ æ›¿ä»£Worker: æä¾›å®Œæ•´Agentåˆ†æåŠŸèƒ½")
    print("æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨")
    print("=" * 50)
    
    uvicorn.run(app, host="0.0.0.0", port=9999)

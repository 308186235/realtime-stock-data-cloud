"""
äº¤æ˜“APIç»Ÿä¸€æ¥å£
ä¸ºAgentæä¾›ç®€å•æ˜“ç”¨çš„äº¤æ˜“å’Œå¯¼å‡ºæ¥å£
"""

import time
from datetime import datetime
from trader_buy_sell import buy_stock, sell_stock, quick_buy, quick_sell
from trader_export import export_holdings, export_transactions, export_orders, export_all_data
from trader_core import cleanup_old_export_files, get_current_focus

class TraderAPI:
    """äº¤æ˜“APIç»Ÿä¸€æ¥å£ç±»"""
    
    def __init__(self):
        self.version = "1.0.0"
        self.last_operation = None
        self.operation_count = 0
        
    def get_status(self):
        """è·å–äº¤æ˜“ç³»ç»ŸçŠ¶æ€"""
        hwnd, current_title = get_current_focus()
        trading_software_active = "äº¤æ˜“" in current_title or "è‚¡ç¥¨" in current_title
        
        return {
            "version": self.version,
            "current_window": current_title,
            "window_handle": hwnd,
            "trading_software_active": trading_software_active,
            "last_operation": self.last_operation,
            "operation_count": self.operation_count,
            "timestamp": datetime.now().isoformat()
        }
    
    def buy(self, code, quantity, price=None):
        """ä¹°å…¥è‚¡ç¥¨
        
        Args:
            code: è‚¡ç¥¨ä»£ç 
            quantity: æ•°é‡
            price: ä»·æ ¼ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™å¸‚ä»·ä¹°å…¥ï¼‰
        
        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        try:
            if price is None:
                result = quick_buy(code, quantity)
            else:
                result = buy_stock(code, price, quantity)
            
            self.last_operation = f"ä¹°å…¥ {code} {quantity}è‚¡"
            if result:
                self.operation_count += 1
            
            return result
        except Exception as e:
            print(f"âŒ ä¹°å…¥æ“ä½œå¤±è´¥: {e}")
            return False
    
    def sell(self, code, quantity, price=None):
        """å–å‡ºè‚¡ç¥¨
        
        Args:
            code: è‚¡ç¥¨ä»£ç 
            quantity: æ•°é‡
            price: ä»·æ ¼ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™å¸‚ä»·å–å‡ºï¼‰
        
        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        try:
            if price is None:
                result = quick_sell(code, quantity)
            else:
                result = sell_stock(code, price, quantity)
            
            self.last_operation = f"å–å‡º {code} {quantity}è‚¡"
            if result:
                self.operation_count += 1
            
            return result
        except Exception as e:
            print(f"âŒ å–å‡ºæ“ä½œå¤±è´¥: {e}")
            return False
    
    def export_data(self, data_type="all"):
        """å¯¼å‡ºæ•°æ®

        Args:
            data_type: æ•°æ®ç±»å‹ ("holdings", "transactions", "orders", "all")

        Returns:
            dict: å¯¼å‡ºç»“æœ
        """
        try:
            if data_type == "holdings":
                result = {"holdings": export_holdings()}
            elif data_type == "transactions":
                result = {"transactions": export_transactions()}
            elif data_type == "orders":
                result = {"orders": export_orders()}
            elif data_type == "all":
                result = export_all_data()
            else:
                print(f"âŒ ä¸æ”¯æŒçš„æ•°æ®ç±»å‹: {data_type}")
                return {"error": f"ä¸æ”¯æŒçš„æ•°æ®ç±»å‹: {data_type}"}

            self.last_operation = f"å¯¼å‡ºæ•°æ® {data_type}"
            self.operation_count += 1

            return result
        except Exception as e:
            print(f"âŒ å¯¼å‡ºæ•°æ®å¤±è´¥: {e}")
            return {"error": f"å¯¼å‡ºæ•°æ®å¤±è´¥: {e}"}

    def export_all(self, data_type="all"):
        """å¯¼å‡ºæ‰€æœ‰æ•°æ® - å…¼å®¹æ€§æ–¹æ³•"""
        return self.export_data(data_type)
    
    def cleanup_files(self):
        """æ¸…ç†è¿‡æœŸæ–‡ä»¶"""
        try:
            cleanup_old_export_files()
            self.last_operation = "æ¸…ç†è¿‡æœŸæ–‡ä»¶"
            return True
        except Exception as e:
            print(f"âŒ æ¸…ç†æ–‡ä»¶å¤±è´¥: {e}")
            return False
    
    def get_portfolio(self):
        """è·å–æŠ•èµ„ç»„åˆï¼ˆé€šè¿‡å¯¼å‡ºæŒä»“æ•°æ®ï¼‰"""
        try:
            result = export_holdings()
            if result:
                self.last_operation = "è·å–æŠ•èµ„ç»„åˆ"
                return {
                    "success": True,
                    "message": "æŠ•èµ„ç»„åˆæ•°æ®å·²å¯¼å‡º",
                    "export_result": result
                }
            else:
                return {
                    "success": False,
                    "message": "æŠ•èµ„ç»„åˆæ•°æ®å¯¼å‡ºå¤±è´¥"
                }
        except Exception as e:
            return {
                "success": False,
                "message": f"è·å–æŠ•èµ„ç»„åˆå¤±è´¥: {e}"
            }
    
    def get_balance(self):
        """è·å–è´¦æˆ·ä½™é¢ï¼ˆéœ€è¦åˆ‡æ¢åˆ°èµ„é‡‘é¡µé¢ï¼‰"""
        try:
            # è¿™é‡Œå¯ä»¥æ·»åŠ è·å–ä½™é¢çš„é€»è¾‘
            # ç›®å‰è¿”å›æ¨¡æ‹Ÿæ•°æ®
            return {
                "success": True,
                "balance": {
                    "total_assets": 100000.00,
                    "available_cash": 50000.00,
                    "market_value": 50000.00,
                    "frozen_cash": 0.00
                },
                "timestamp": datetime.now().isoformat()
            }
        except Exception as e:
            return {
                "success": False,
                "message": f"è·å–ä½™é¢å¤±è´¥: {e}"
            }

# åˆ›å»ºå…¨å±€APIå®ä¾‹
api = TraderAPI()

# ä¾¿æ·å‡½æ•°
def get_trader_api():
    """è·å–äº¤æ˜“APIå®ä¾‹"""
    return api

def test_trader_api():
    """æµ‹è¯•äº¤æ˜“API"""
    print("ğŸ§ª äº¤æ˜“APIæµ‹è¯•")
    print("=" * 50)
    
    # æµ‹è¯•çŠ¶æ€è·å–
    status = api.get_status()
    print(f"âœ… çŠ¶æ€è·å–: {status}")
    
    # æµ‹è¯•ä½™é¢è·å–
    balance = api.get_balance()
    print(f"âœ… ä½™é¢è·å–: {balance}")
    
    print("âœ… äº¤æ˜“APIæµ‹è¯•å®Œæˆ")

if __name__ == "__main__":
    test_trader_api()
